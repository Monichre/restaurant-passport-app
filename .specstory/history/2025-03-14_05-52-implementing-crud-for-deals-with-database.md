<!-- Generated by SpecStory -->

# Implementing CRUD for Deals with Database (2025-03-14 00:52:54)

_**User**_

add create, edit and delete functionality with actual database methods for deals

---

_**Assistant**_

<think>Let me analyze what the user is asking for. The user wants to add create, edit, and delete functionality for deals using actual database methods instead of the mock data currently being used.

From the provided code and linter errors, I can see:

1. There's a `DealsTable` component with mock data that displays a table of deals
2. There's a linter error about `deal.restaurant?.name` not existing on the `Deal` type
3. There are database functions for deals (`createRestaurantDeal`, `updateRestaurantDeal`, `deleteRestaurantDeal`)

I need to:

1. Implement the actual delete functionality (replacing the stub `handleDelete` function)
2. Create routes for creating and editing deals
3. Fix the linter error by either updating the type or accessing the restaurant name differently

Let me explore more of the codebase to understand the structure and find the Deal type.</think>I'll implement CRUD functionality for deals using the actual database methods. First, let's understand what we need:

---

<details>
            <summary>Grep search for "import.*Deal" • **20** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts` | L4 | `import { restaurants, prizes, punchCards, restaurantDeals } from "../../schema";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/%28public%29/deals/page.tsx` | L1 | `import { DealsList, DealsListSkeleton } from "@/features/deals";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L6 | `import { DealsList } from "@/features/deals";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/features/deals/DealsList.tsx` | L8 | `import type { Deal } from "@/types/db";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/page.tsx` | Lundefined | `import { DealsTable } from "@/components/admin/deals/deals-table";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/page.tsx` | L1 | `import { DealFilters } from "@/components/admin/deals/deal-filters";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/new/page.tsx` | Lundefined | `import { NewDealForm } from "@/components/admin/deals/new-deal-form";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/%5Bid%5D/page.tsx` | Lundefined | `import { DealDetail } from "@/components/admin/deals/deal-detail";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/restaurant-deals-display.tsx` | L5 | `import type { Deal } from "./restaurant-quick-view";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/restaurant-quick-view.tsx` | L34 | `import { DealsList, EmptyDeals } from "./restaurant-deals-display";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/edit-deal-form.tsx` | L4 | `import type { Deal, Restaurant } from "@/types/db";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/%5Bid%5D/edit/page.tsx` | Lundefined | `import { EditDealForm } from "@/components/admin/deals/edit-deal-form";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/deals-table.tsx` | L6 | `import type { Deal, Restaurant } from "@/types/db";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/deal-detail.tsx` | L7 | `import type { Deal, Restaurant } from "@/types/db";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts` | L4 | `import { restaurants, prizes, punchCards, restaurantDeals } from "../../schema";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/restaurant-quick-view.tsx` | L34 | `import { DealsList, EmptyDeals } from "./restaurant-deals-display";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/%28public%29/deals/page.tsx` | L1 | `import { DealsList, DealsListSkeleton } from "@/features/deals";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/features/deals/DealsList.tsx` | L8 | `import type { Deal } from "@/types/db";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L6 | `import { DealsList } from "@/features/deals";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/deals-table.tsx` | L6 | `import type { Deal, Restaurant } from "@/types/db";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/page.tsx` | Lundefined | `import { DealFilters } from "@/components/admin/deals/deal-filters";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/page.tsx` | L1 | `import { DealsTable } from "@/components/admin/deals/deals-table";` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/page.tsx` | L2 | `import { getDeals } from "@/db/models/restaurants/restaurants";` |

</details>

---

Let's check the Deal type from the DB types:

---

<details>
            <summary>Searched codebase "types/db.ts" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/types/db.ts

---

Now I need to check the DB methods available for deals:

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts

---

Let's look at the deals admin page implementation:

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/page.tsx

---

Now let's check the current deals-table implementation:

---

```diff
  import Image from "next/image";
  import { Edit, Trash2, Eye } from "lucide-react";
- import type { Deal, Restaurant } from "@/types/db";
+ import type { Deal } from "@/types/db";
+ import { deleteRestaurantDeal } from "@/db/models/restaurants/restaurants";
+ import { useRouter } from "next/navigation";
+ import {
+ 	AlertDialog,
+ 	AlertDialogAction,
+ 	AlertDialogCancel,
+ 	AlertDialogContent,
+ 	AlertDialogDescription,
+ 	AlertDialogFooter,
+ 	AlertDialogHeader,
+ 	AlertDialogTitle,
+ } from "@/components/ui/alert-dialog";
+ import { toast } from "@/components/ui/use-toast";
  
  // Mock data for development purposes, replace with actual API calls later
- const mockDeals: Array<Deal & { restaurant?: Restaurant }> = [
+ const mockDeals: Array<Deal & { restaurant?: { name: string } }> = [
  	{
  		id: BigInt(1),
```

```diff
  ];
  
- export function DealsTable({ deals }: { deals: Deal[] }) {
+ export function DealsTable({
+ 	deals,
+ }: { deals: Array<Deal & { restaurant?: { name: string } }> }) {
  	const [isDeleting, setIsDeleting] = useState<bigint | null>(null);
+ 	const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
+ 	const [dealToDelete, setDealToDelete] = useState<bigint | null>(null);
+ 	const router = useRouter();
  
  	// Function to handle deal deletion
  	const handleDelete = async (id: bigint) => {
- 		setIsDeleting(id);
+ 		setDealToDelete(id);
+ 		setShowDeleteConfirm(true);
+ 	};
+ 
+ 	const confirmDelete = async () => {
+ 		if (!dealToDelete) return;
+ 
+ 		try {
+ 			setIsDeleting(dealToDelete);
+ 			await deleteRestaurantDeal(dealToDelete);
+ 			toast({
+ 				title: "Deal deleted",
+ 				description: "The deal has been successfully deleted.",
+ 			});
+ 			router.refresh(); // Refresh the page to update the deals list
+ 		} catch (error) {
+ 			console.error("Error deleting deal:", error);
+ 			toast({
+ 				title: "Error",
+ 				description: "Failed to delete the deal. Please try again.",
+ 				variant: "destructive",
+ 			});
+ 		} finally {
+ 			setIsDeleting(null);
+ 			setShowDeleteConfirm(false);
+ 			setDealToDelete(null);
+ 		}
+ 	};
+ 
+ 	const cancelDelete = () => {
+ 		setShowDeleteConfirm(false);
+ 		setDealToDelete(null);
  	};
  
  	return (
+ 		<>
  			<div className="w-full overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
  				<div className="overflow-x-auto">
```

```diff
  										</td>
  										<td className="whitespace-nowrap px-6 py-4">
- 										<span className="font-medium">{deal.restaurant?.name}</span>
+ 											<span className="font-medium">
+ 												{deal.restaurant?.name}
+ 											</span>
  										</td>
  										<td className="whitespace-nowrap px-6 py-4">
```

```diff
  				</div>
  			</div>
+ 
+ 			{/* Delete confirmation dialog */}
+ 			<AlertDialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>
+ 				<AlertDialogContent>
+ 					<AlertDialogHeader>
+ 						<AlertDialogTitle>Are you sure?</AlertDialogTitle>
+ 						<AlertDialogDescription>
+ 							This will permanently delete this deal. This action cannot be
+ 							undone.
+ 						</AlertDialogDescription>
+ 					</AlertDialogHeader>
+ 					<AlertDialogFooter>
+ 						<AlertDialogCancel onClick={cancelDelete}>Cancel</AlertDialogCancel>
+ 						<AlertDialogAction
+ 							onClick={confirmDelete}
+ 							className="bg-red-600 hover:bg-red-700 focus:ring-red-600"
+ 						>
+ 							{isDeleting ? "Deleting..." : "Delete"}
+ 						</AlertDialogAction>
+ 					</AlertDialogFooter>
+ 				</AlertDialogContent>
+ 			</AlertDialog>
+ 		</>
  	);
  }
```

---

Let's fix the linter errors by checking the UI components and creating the missing toast component if needed:

---

<details>
            <summary>Searched codebase "use-toast.ts" • **2** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |

</details>

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/hooks/use-toast.tsx

---

Let's check if there's a Toast component:

---

<details>
            <summary>Searched codebase "toast.tsx" • **4** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/components/ui/toast.tsx

---

<details>
            <summary>Searched codebase "use-toast export" • **2** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |

</details>

---

Let's see if there's a component that provides the Toast context:

---

<details>
            <summary>Searched codebase "toaster.tsx" • **2** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |

</details>

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/components/ui/toaster.tsx

---

Now let's check if there's an existing AlertDialog component:

---

<details>
            <summary>Searched codebase "alert-dialog.tsx" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---

Let's update the DealsTable component to fix the linter errors:

---

```diff
  	AlertDialogTitle,
  } from "@/components/ui/alert-dialog";
- 
+ import { useToast } from "@/hooks/use-toast";
+ 
+ // Define the type for the deals with restaurant name
+ type DealWithRestaurant = Deal & {
+ 	restaurant?: {
+ 		name: string;
+ 		id?: bigint;
+ 	};
+ };
  
  // Mock data for development purposes, replace with actual API calls later
```

```diff
  ];
  
- export function DealsTable({
- 	deals,
- }: { deals: Array<Deal & { restaurant?: { name: string } }> }) {
+ export function DealsTable({ deals }: { deals: DealWithRestaurant[] }) {
  	const [isDeleting, setIsDeleting] = useState<bigint | null>(null);
  	const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  	const [dealToDelete, setDealToDelete] = useState<bigint | null>(null);
  	const router = useRouter();
+ 	const { toast } = useToast();
  
  	// Function to handle deal deletion
```

---

Let's completely remove the mock data since we're using real data now, and adjust the type:

---

```diff
  	restaurant?: {
  		name: string;
- 		id?: bigint;
  	};
  };
- 
- // Mock data for development purposes, replace with actual API calls later
- const mockDeals: Array<Deal & { restaurant?: { name: string } }> = [
- 	{
- 		id: BigInt(1),
- 		title: "Half-price Appetizers",
- 		content: "Enjoy half-price appetizers every Tuesday from 5-7pm.",
- 		imageUrl: "/images/deals/appetizers.jpg",
- 		active: true,
- 		restaurantId: BigInt(1),
- 		createdAt: new Date("2023-06-15"),
- 		updatedAt: new Date("2023-06-15"),
- 		restaurant: {
- 			id: BigInt(1),
- 			name: "Pasta Paradise",
- 			description: "Authentic Italian cuisine",
- 			imageUrl: "/images/restaurants/pasta-paradise.jpg",
- 			address: "123 Main St, Anytown, USA",
- 			qrCodeUrl: null,
- 		},
- 	},
- 	{
- 		id: BigInt(2),
- 		title: "Buy One Get One Free",
- 		content:
- 			"Buy one entrée and get one of equal or lesser value for free. Valid Monday-Thursday.",
- 		imageUrl: "/images/deals/bogo.jpg",
- 		active: true,
- 		restaurantId: BigInt(2),
- 		createdAt: new Date("2023-07-01"),
- 		updatedAt: new Date("2023-07-10"),
- 		restaurant: {
- 			id: BigInt(2),
- 			name: "Burger Barn",
- 			description: "Gourmet burgers and craft beers",
- 			imageUrl: "/images/restaurants/burger-barn.jpg",
- 			address: "456 Oak St, Anytown, USA",
- 			qrCodeUrl: null,
- 		},
- 	},
- 	{
- 		id: BigInt(3),
- 		title: "Free Dessert with Purchase",
- 		content:
- 			"Receive a free dessert with any purchase over $25. Limited time offer.",
- 		imageUrl: "/images/deals/dessert.jpg",
- 		active: false,
- 		restaurantId: BigInt(1),
- 		createdAt: new Date("2023-05-20"),
- 		updatedAt: new Date("2023-07-15"),
- 		restaurant: {
- 			id: BigInt(1),
- 			name: "Pasta Paradise",
- 			description: "Authentic Italian cuisine",
- 			imageUrl: "/images/restaurants/pasta-paradise.jpg",
- 			address: "123 Main St, Anytown, USA",
- 			qrCodeUrl: null,
- 		},
- 	},
- ];
  
  export function DealsTable({ deals }: { deals: DealWithRestaurant[] }) {
```

---

Now let's create the edit form component:

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/edit-deal-form.tsx

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/edit-deal-form.tsx

---

Now let's look for the new deal form:

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/components/admin/deals/new-deal-form.tsx

---

Let's check for restaurant fetching:

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts

---

Now let's update the NewDealForm component to use the real database methods:

---

```diff
  "use client";
  
- import { useState } from "react";
+ import { useState, useEffect } from "react";
  import { useRouter } from "next/navigation";
  import type { Restaurant } from "@/types/db";
- 
- // Mock data for restaurant selection
- const mockRestaurants: Restaurant[] = [
- 	{
- 		id: BigInt(1),
- 		name: "Pasta Paradise",
- 		description: "Authentic Italian cuisine",
- 		imageUrl: "/images/restaurants/pasta-paradise.jpg",
- 		address: "123 Main St, Anytown, USA",
- 		qrCodeUrl: null,
- 	},
- 	{
- 		id: BigInt(2),
- 		name: "Burger Barn",
- 		description: "Gourmet burgers and craft beers",
- 		imageUrl: "/images/restaurants/burger-barn.jpg",
- 		address: "456 Oak St, Anytown, USA",
- 		qrCodeUrl: null,
- 	},
- 	{
- 		id: BigInt(3),
- 		name: "Sushi Spot",
- 		description: "Fresh sushi and Japanese cuisine",
- 		imageUrl: "/images/restaurants/sushi-spot.jpg",
- 		address: "789 Pine St, Anytown, USA",
- 		qrCodeUrl: null,
- 	},
- ];
+ import { createRestaurantDeal } from "@/db/models/restaurants/restaurants";
+ import { getRestaurants } from "@/db/models/restaurants/restaurants";
+ import { useToast } from "@/hooks/use-toast";
  
  export function NewDealForm() {
  	const router = useRouter();
+ 	const { toast } = useToast();
+ 	const [restaurants, setRestaurants] = useState<Restaurant[]>([]);
+ 	const [isLoadingRestaurants, setIsLoadingRestaurants] = useState(true);
  
  	const [formData, setFormData] = useState({
```

```diff
  	const [isSubmitting, setIsSubmitting] = useState(false);
  	const [error, setError] = useState<string | null>(null);
+ 
+ 	// Fetch restaurants
+ 	useEffect(() => {
+ 		const fetchRestaurants = async () => {
+ 			try {
+ 				setIsLoadingRestaurants(true);
+ 				const restaurantsList = await getRestaurants();
+ 				setRestaurants(restaurantsList);
+ 			} catch (err) {
+ 				console.error("Error fetching restaurants:", err);
+ 				setError("Failed to load restaurants");
+ 			} finally {
+ 				setIsLoadingRestaurants(false);
+ 			}
+ 		};
+ 
+ 		fetchRestaurants();
+ 	}, []);
  
  	const handleChange = (
```

```diff
  			}
  
- 			// In a real app, this would be an API call to create the deal
- 			console.log("Creating deal:", formData);
- 
- 			// Simulate API delay
- 			await new Promise((resolve) => setTimeout(resolve, 1000));
+ 			// Create the deal in the database
+ 			await createRestaurantDeal({
+ 				title: formData.title,
+ 				content: formData.content,
+ 				active: formData.active,
+ 				restaurantId: BigInt(formData.restaurantId),
+ 			});
+ 
+ 			toast({
+ 				title: "Deal created",
+ 				description: "The deal has been successfully created.",
+ 			});
  
  			// Redirect to deals listing page on success
```

```diff
  		} catch (err) {
  			setError(err instanceof Error ? err.message : "Failed to create deal");
+ 			toast({
+ 				title: "Error",
+ 				description: "Failed to create the deal. Please try again.",
+ 				variant: "destructive",
+ 			});
  			setIsSubmitting(false);
  		}
```

```diff
  						className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-[#818cf8] focus:outline-none focus:ring-1 focus:ring-[#818cf8] sm:text-sm"
  						required
+ 						disabled={isLoadingRestaurants}
  					>
  						<option value="">Select Restaurant</option>
- 						{mockRestaurants.map((restaurant) => (
+ 						{restaurants.map((restaurant) => (
  							<option key={String(restaurant.id)} value={String(restaurant.id)}>
  								{restaurant.name}
  							</option>
  						))}
  					</select>
+ 					{isLoadingRestaurants && (
+ 						<p className="mt-1 text-xs text-gray-500">Loading restaurants...</p>
+ 					)}
  				</div>
  
```

---

Let's fix the typing issue in the NewDealForm:

---

```diff
  import { getRestaurants } from "@/db/models/restaurants/restaurants";
  import { useToast } from "@/hooks/use-toast";
+ 
+ // Define a simplified restaurant type for the select dropdown
+ type SimpleRestaurant = {
+ 	id: bigint;
+ 	name: string;
+ };
  
  export function NewDealForm() {
  	const router = useRouter();
  	const { toast } = useToast();
- 	const [restaurants, setRestaurants] = useState<Restaurant[]>([]);
+ 	const [restaurants, setRestaurants] = useState<SimpleRestaurant[]>([]);
  	const [isLoadingRestaurants, setIsLoadingRestaurants] = useState(true);
  
```

```diff
  				setIsLoadingRestaurants(true);
  				const restaurantsList = await getRestaurants();
- 				setRestaurants(restaurantsList);
+ 				// Simplify the restaurant data to only what we need for the dropdown
+ 				const simpleRestaurants = restaurantsList.map((restaurant) => ({
+ 					id: restaurant.id,
+ 					name: restaurant.name,
+ 				}));
+ 				setRestaurants(simpleRestaurants);
  			} catch (err) {
  				console.error("Error fetching restaurants:", err);
```

---

Now let's update the EditDealForm component to use the real database methods:

---

```diff
  import { useState, useEffect } from "react";
  import { useRouter } from "next/navigation";
- import type { Deal, Restaurant } from "@/types/db";
- 
- // Mock data for restaurant selection
- const mockRestaurants: Restaurant[] = [
- 	{
- 		id: BigInt(1),
- 		name: "Pasta Paradise",
- 		description: "Authentic Italian cuisine",
- 		imageUrl: "/images/restaurants/pasta-paradise.jpg",
- 		address: "123 Main St, Anytown, USA",
- 		qrCodeUrl: null,
- 	},
- 	{
- 		id: BigInt(2),
- 		name: "Burger Barn",
- 		description: "Gourmet burgers and craft beers",
- 		imageUrl: "/images/restaurants/burger-barn.jpg",
- 		address: "456 Oak St, Anytown, USA",
- 		qrCodeUrl: null,
- 	},
- 	{
- 		id: BigInt(3),
- 		name: "Sushi Spot",
- 		description: "Fresh sushi and Japanese cuisine",
- 		imageUrl: "/images/restaurants/sushi-spot.jpg",
- 		address: "789 Pine St, Anytown, USA",
- 		qrCodeUrl: null,
- 	},
- ];
- 
- // Mock function to get deal data - would be replaced with an API call in a real app
- const getMockDeal = (
- 	id: string,
- ): (Deal & { restaurant?: Restaurant }) | null => {
- 	const deals = [
- 		{
- 			id: BigInt(1),
- 			title: "Half-price Appetizers",
- 			content: "Enjoy half-price appetizers every Tuesday from 5-7pm.",
- 			imageUrl: "/images/deals/appetizers.jpg",
- 			active: true,
- 			restaurantId: BigInt(1),
- 			createdAt: new Date("2023-06-15"),
- 			updatedAt: new Date("2023-06-15"),
- 			restaurant: {
- 				id: BigInt(1),
- 				name: "Pasta Paradise",
- 				description: "Authentic Italian cuisine",
- 				imageUrl: "/images/restaurants/pasta-paradise.jpg",
- 				address: "123 Main St, Anytown, USA",
- 				qrCodeUrl: null,
- 			},
- 		},
- 		{
- 			id: BigInt(2),
- 			title: "Buy One Get One Free",
- 			content:
- 				"Buy one entrée and get one of equal or lesser value for free. Valid Monday-Thursday.",
- 			imageUrl: "/images/deals/bogo.jpg",
- 			active: true,
- 			restaurantId: BigInt(2),
- 			createdAt: new Date("2023-07-01"),
- 			updatedAt: new Date("2023-07-10"),
- 			restaurant: {
- 				id: BigInt(2),
- 				name: "Burger Barn",
- 				description: "Gourmet burgers and craft beers",
- 				imageUrl: "/images/restaurants/burger-barn.jpg",
- 				address: "456 Oak St, Anytown, USA",
- 				qrCodeUrl: null,
- 			},
- 		},
- 		{
- 			id: BigInt(3),
- 			title: "Free Dessert with Purchase",
- 			content:
- 				"Receive a free dessert with any purchase over $25. Limited time offer.",
- 			imageUrl: "/images/deals/dessert.jpg",
- 			active: false,
- 			restaurantId: BigInt(1),
- 			createdAt: new Date("2023-05-20"),
- 			updatedAt: new Date("2023-07-15"),
- 			restaurant: {
- 				id: BigInt(1),
- 				name: "Pasta Paradise",
- 				description: "Authentic Italian cuisine",
- 				imageUrl: "/images/restaurants/pasta-paradise.jpg",
- 				address: "123 Main St, Anytown, USA",
- 				qrCodeUrl: null,
- 			},
- 		},
- 	];
- 
- 	const parsedId = BigInt(id);
- 	return deals.find((deal) => deal.id === parsedId) || null;
- };
- 
+ import type { Deal } from "@/types/db";
+ import {
+ 	getRestaurants,
+ 	updateRestaurantDeal,
+ } from "@/db/models/restaurants/restaurants";
+ import { useToast } from "@/hooks/use-toast";
+ 
+ // Define a simplified restaurant type for the select dropdown
+ type SimpleRestaurant = {
+ 	id: bigint;
+ 	name: string;
+ };
+ 
+ // Define the props for the component
  interface EditDealFormProps {
  	id: string;
+ 	deal: Deal & { restaurant?: { id: bigint; name: string } };
  }
  
- export function EditDealForm({ id }: EditDealFormProps) {
+ export function EditDealForm({ id, deal }: EditDealFormProps) {
  	const router = useRouter();
+ 	const { toast } = useToast();
+ 	const [restaurants, setRestaurants] = useState<SimpleRestaurant[]>([]);
+ 	const [isLoadingRestaurants, setIsLoadingRestaurants] = useState(true);
  
  	const [formData, setFormData] = useState({
- 		title: "",
- 		content: "",
- 		imageUrl: "",
- 		active: true,
- 		restaurantId: "",
+ 		title: deal.title,
+ 		content: deal.content,
+ 		imageUrl: deal.imageUrl || "",
+ 		active: deal.active,
+ 		restaurantId: String(deal.restaurantId),
  	});
  
- 	const [isLoading, setIsLoading] = useState(true);
  	const [isSubmitting, setIsSubmitting] = useState(false);
  	const [error, setError] = useState<string | null>(null);
  
- 	// Fetch deal data on component mount
+ 	// Fetch restaurants for the dropdown
  	useEffect(() => {
- 		const fetchDeal = async () => {
+ 		const fetchRestaurants = async () => {
  			try {
- 				setIsLoading(true);
- 				setError(null);
- 
- 				// Simulate API delay
- 				await new Promise((resolve) => setTimeout(resolve, 500));
- 
- 				const deal = getMockDeal(id);
- 
- 				if (!deal) {
- 					setError("Deal not found");
- 					return;
- 				}
- 
- 				setFormData({
- 					title: deal.title,
- 					content: deal.content,
- 					imageUrl: deal.imageUrl || "",
- 					active: deal.active,
- 					restaurantId: String(deal.restaurantId),
- 				});
+ 				setIsLoadingRestaurants(true);
+ 				const restaurantsList = await getRestaurants();
+ 				// Simplify the restaurant data to only what we need for the dropdown
+ 				const simpleRestaurants = restaurantsList.map((restaurant) => ({
+ 					id: restaurant.id,
+ 					name: restaurant.name,
+ 				}));
+ 				setRestaurants(simpleRestaurants);
  			} catch (err) {
- 				setError("Failed to load deal data");
- 				console.error("Error fetching deal:", err);
+ 				console.error("Error fetching restaurants:", err);
+ 				setError("Failed to load restaurants");
  			} finally {
- 				setIsLoading(false);
+ 				setIsLoadingRestaurants(false);
  			}
  		};
  
- 		fetchDeal();
- 	}, [id]);
+ 		fetchRestaurants();
+ 	}, []);
  
  	const handleChange = (
```

```diff
  			}
  
- 			// In a real app, this would be an API call to update the deal
- 			console.log("Updating deal:", { id, ...formData });
- 
- 			// Simulate API delay
- 			await new Promise((resolve) => setTimeout(resolve, 1000));
+ 			// Update the deal in the database
+ 			await updateRestaurantDeal(BigInt(id), {
+ 				title: formData.title,
+ 				content: formData.content,
+ 				active: formData.active,
+ 				restaurantId: BigInt(formData.restaurantId),
+ 			});
+ 
+ 			toast({
+ 				title: "Deal updated",
+ 				description: "The deal has been successfully updated.",
+ 			});
  
  			// Redirect to deal detail page on success
```

```diff
  		} catch (err) {
  			setError(err instanceof Error ? err.message : "Failed to update deal");
+ 			toast({
+ 				title: "Error",
+ 				description: "Failed to update the deal. Please try again.",
+ 				variant: "destructive",
+ 			});
  			setIsSubmitting(false);
  		}
  	};
- 
- 	if (isLoading) {
- 		return (
- 			<div className="animate-pulse space-y-4">
- 				<div className="h-10 bg-gray-200 rounded w-1/2" />
- 				<div className="h-32 bg-gray-200 rounded" />
- 				<div className="h-10 bg-gray-200 rounded w-1/3" />
- 				<div className="h-10 bg-gray-200 rounded w-1/4" />
- 			</div>
- 		);
- 	}
  
  	if (error && !isSubmitting) {
```

```diff
  						className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-[#818cf8] focus:outline-none focus:ring-1 focus:ring-[#818cf8] sm:text-sm"
  						required
+ 						disabled={isLoadingRestaurants}
  					>
  						<option value="">Select Restaurant</option>
- 						{mockRestaurants.map((restaurant) => (
+ 						{restaurants.map((restaurant) => (
  							<option key={String(restaurant.id)} value={String(restaurant.id)}>
  								{restaurant.name}
  							</option>
  						))}
  					</select>
+ 					{isLoadingRestaurants && (
+ 						<p className="mt-1 text-xs text-gray-500">Loading restaurants...</p>
+ 					)}
  				</div>
  
```

---

Let's update the edit deal page to pass the deal data to the EditDealForm component:

---

Read file: /Users/liamellis/Desktop/restaurant-passport-app/src/app/admin/deals/[id]/edit/page.tsx

---

```diff
  import { EditDealForm } from "@/components/admin/deals/edit-deal-form";
+ import { notFound } from "next/navigation";
+ import { getDeals } from "@/db/models/restaurants/restaurants";
  
  export const metadata = {
```

```diff
  };
  
- export default function EditDealPage({ params }: { params: { id: string } }) {
+ export default async function EditDealPage({
+ 	params,
+ }: { params: { id: string } }) {
+ 	// Fetch the deal data
+ 	const deals = await getDeals();
+ 	const deal = deals.find((deal) => deal.id === BigInt(params.id));
+ 
+ 	// If the deal doesn't exist, show 404
+ 	if (!deal) {
+ 		notFound();
+ 	}
+ 
  	return (
  		<div className="space-y-6">
```

```diff
  
  			<div className="bg-white rounded-lg shadow-sm p-6">
- 				<EditDealForm id={params.id} />
+ 				<EditDealForm id={params.id} deal={deal} />
  			</div>
  		</div>
```

---

Great! We've successfully implemented the CRUD functionality for deals using the actual database methods:

1. **Create**: We updated the `NewDealForm` component to use `createRestaurantDeal` method to create new deals.
2. **Read**: We're using the `getDeals` method to retrieve all deals with their associated restaurants.
3. **Update**: We updated the `EditDealForm` component to use `updateRestaurantDeal` method to update existing deals.
4. **Delete**: We implemented the delete functionality in the `DealsTable` component using the `deleteRestaurantDeal` method with a confirmation dialog.

Here's a summary of the changes:

1. For the `DealsTable` component:
   - Added a confirmation dialog for delete operations
   - Implemented the actual delete functionality with error handling
   - Added toast notifications for success/error feedback

2. For the `NewDealForm` component:
   - Replaced mock data with real database methods
   - Added real-time restaurant fetching for the dropdown
   - Implemented proper error handling and user feedback

3. For the `EditDealForm` component:
   - Replaced mock data with real database methods
   - Added real-time restaurant fetching for the dropdown
   - Updated to accept the deal data as a prop

4. For the edit page:
   - Made it an async server component that fetches the deal data
   - Added a 404 not found response for invalid deal IDs

All components now use proper type definitions and the real database methods for CRUD operations. The forms provide appropriate feedback to users through toast notifications, and there are loading states where appropriate.

---

