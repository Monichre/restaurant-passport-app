<!-- Generated by SpecStory -->

# User Raffle Subscription Function (2025-04-14 09:06:44)

_**User**_

Create a useUserRaffleSubscription that subscribes to the raffle by user id

---

_**Assistant**_



---

Could not find file 'src/db/models/raffle-entries.ts'. Did you mean one of:
- src/db/models/raffle-entries/index.ts
- src/db/models/raffle-entries/raffle-entries.ts

---

Read file: src/db/models/raffle-entries/index.ts

---

Read file: src/db/models/raffle-entries/raffle-entries.ts

---

Read file: src/types/index.ts

---

Read file: src/types/db.ts

---

```diff
- 
+ 'use client'
+ 
+ import {useState, useEffect, useCallback} from 'react'
+ import {supabaseBrowserClient} from '@/db/supabase/supabase.client'
+ import type {RaffleEntry} from '@/types'
+ import {getRaffleEntriesByUserId} from '@/db/models/raffle-entries'
+ 
+ /**
+  * A hook for subscribing to real-time raffle entries updates for a specific user
+  * @param userId - The user ID to filter raffle entries by
+  * @returns The updated raffle entries array with loading and error states
+  */
+ export function useUserRaffleSubscription(userId: bigint) {
+   const [raffleEntries, setRaffleEntries] = useState<RaffleEntry[]>([])
+   const [isLoading, setIsLoading] = useState(true)
+   const [error, setError] = useState<Error | null>(null)
+ 
+   const fetchUserRaffleEntries = useCallback(async () => {
+     try {
+       setIsLoading(true)
+       const entries = await getRaffleEntriesByUserId(userId)
+ 
+       // Convert string dates to Date objects to match RaffleEntry type
+       const formattedEntries = entries.map((entry) => ({
+         ...entry,
+         createdAt: entry.createdAt ? new Date(entry.createdAt) : new Date(),
+       }))
+ 
+       setRaffleEntries(formattedEntries)
+       setError(null)
+     } catch (err) {
+       setError(
+         err instanceof Error ? err : new Error('Failed to fetch raffle entries')
+       )
+     } finally {
+       setIsLoading(false)
+     }
+   }, [userId])
+ 
+   // Fetch initial raffle entries
+   useEffect(() => {
+     fetchUserRaffleEntries()
+   }, [fetchUserRaffleEntries])
+ 
+   // Set up real-time subscription
+   useEffect(() => {
+     // Subscribe to events on raffle_entries table filtered by user ID
+     const subscription = supabaseBrowserClient
+       .channel(`raffle-user-${userId}`)
+       .on(
+         'postgres_changes',
+         {
+           event: '*',
+           schema: 'public',
+           table: 'raffle_entries',
+           filter: `userId=eq.${userId}`,
+         },
+         async () => {
+           await fetchUserRaffleEntries()
+         }
+       )
+       .subscribe()
+ 
+     // Clean up subscription on unmount
+     return () => {
+       subscription.unsubscribe()
+     }
+   }, [userId, fetchUserRaffleEntries])
+ 
+   return {
+     raffleEntries,
+     isLoading,
+     error,
+   }
+ }
+ 
```

---

I've created a new hook called `useUserRaffleSubscription` that subscribes to raffle entries for a specific user. The hook:

1. Takes a `userId` parameter to filter entries
2. Fetches initial raffle entries for the specific user
3. Sets up a real-time Supabase subscription filtered by that user ID
4. Converts string dates to Date objects to fix the type error in the original hook
5. Provides proper error handling
6. Returns the entries along with loading and error states
7. Properly cleans up the subscription when the component unmounts

The hook follows the same pattern as the existing `useRaffleEntriesSubscription` but adds user-specific filtering both for the initial data fetch and the real-time subscription.

---

```diff
        console.log('ðŸš€ ~ fetchRaffleEntries ~ entries:', entries)
  
-       setRaffleEntries(entries)
+       // Convert string dates to Date objects to match RaffleEntry type
+       const formattedEntries = entries.map((entry) => ({
+         ...entry,
+         createdAt: entry.createdAt ? new Date(entry.createdAt) : new Date(),
+       }))
+ 
+       setRaffleEntries(formattedEntries)
        setError(null)
+     } catch (err) {
+       setError(
+         err instanceof Error ? err : new Error('Failed to fetch raffle entries')
+       )
      } finally {
        setIsLoading(false)
```

```diff
          'postgres_changes',
          {event: '*', schema: 'public', table: 'raffle_entries'},
-         async (payload) => {
-           console.log('Change received!', payload)
-           fetchRaffleEntries()
+         async () => {
+           await fetchRaffleEntries()
          }
        )
```

---

