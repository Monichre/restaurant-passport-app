<!-- Generated by SpecStory -->

# User Profile Punch Card UI Design (2025-03-03 06:49:31)

_**User**_

Generate a UI on the user profile to display all of their punch cards by restaurant

---

_**Assistant**_

I'll create a UI component to display all of a user's punch cards by restaurant on their profile page. First, I need to understand the current structure and check if we have the necessary data models.

---

<details>
            <summary>Searched codebase "punch card model schema or functions" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/db.ts` | L28-40 |
| `src/types/schemas.ts` | L55-67 |
| `src/db/models/punch-cards/punch-cards.ts` | L88-103 |
| `src/db/models/punch-cards/punch-cards.ts` | L74-88 |
| `src/db/models/punch-cards/punch-cards.ts` | L9-17 |
| `src/db/models/punch-cards/punch-cards.ts` | L65-74 |
| `src/db/schema.ts` | L198-229 |
| `src/db/models/punch-cards/punch-cards.ts` | L1-9 |
| `src/db/models/punch-cards/punch-cards.ts` | L103-107 |
| `src/db/models/punch-cards/punch-cards.ts` | L17-24 |
| `src/db/models/prize-redemptions/prize-redemptions.ts` | L29-36 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L22-29 |
| `src/types/schemas.ts` | L67-74 |
| `src/types/schemas.ts` | L74-76 |
| `src/db/models/punch-cards/punch-cards.ts` | L41-48 |
| `src/db/schema.ts` | L173-198 |
| `src/db/models/punch-cards/punch-cards.ts` | L48-65 |
| `src/db/models/punch-cards/punch-cards.ts` | L24-41 |
| `src/db/schema.ts` | L109-146 |
| `.cursor/rules/prd.mdc` | L163-217 |
| `src/db/models/prize-redemptions/prize-redemptions.ts` | L43-54 |
| `src/types/db.ts` | L40-50 |
| `src/types/schemas.ts` | L118-129 |
| `drizzle/meta/0002_snapshot.json` | L380-446 |
| `drizzle/meta/0001_snapshot.json` | L380-446 |

</details>

---



Now I need to check if we have a restaurant model to display restaurant information alongside the punch cards:

---

<details>
            <summary>Searched codebase "restaurant model schema or functions" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/schemas.ts` | L36-48 |
| `src/types/db.ts` | L16-28 |
| `src/db/models/restaurants/restaurants.ts` | L36-45 |
| `src/db/models/restaurants/restaurants.ts` | L1-9 |
| `src/db/models/restaurants/restaurants.ts` | L45-62 |
| `src/db/schema.ts` | L1-22 |
| `src/types/schemas.ts` | L48-53 |
| `src/db/models/restaurants/restaurants.ts` | L9-18 |
| `src/db/models/restaurants/restaurants.ts` | L62-66 |
| `src/types/schemas.ts` | L53-55 |
| `src/db/schema.ts` | L146-173 |
| `src/db/models/restaurants/restaurants.ts` | L18-36 |
| `src/app/api/ai/enrich/restaurant/route.ts` | L1-24 |
| `drizzle/meta/0002_snapshot.json` | L545-594 |
| `drizzle/meta/0001_snapshot.json` | L545-594 |
| `src/db/models/prizes/prizes.ts` | L11-18 |
| `src/types/db.ts` | L77-81 |
| `src/types/api.ts` | L60-67 |
| `src/db/models/prizes/prizes.ts` | L22-36 |
| `src/db/models/restaurants/index.ts` | L1-1 |
| `src/db/models/index.ts` | L1-2 |
| `src/types/schemas.ts` | L87-101 |
| `.cursor/rules/prd.mdc` | L112-163 |
| `src/types/db.ts` | L60-77 |
| `drizzle/meta/0000_snapshot.json` | L545-588 |

</details>

---



Now I need to check if there are any existing components for displaying punch cards:

---

<details>
            <summary>Searched codebase "punch card component or UI" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/features/users/UserPunchCard.tsx` | L1-20 |
| `src/features/users/GetUserPunchCard.tsx` | L1-27 |
| `src/types/db.ts` | L28-40 |
| `src/db/models/punch-cards/punch-cards.ts` | L88-103 |
| `src/features/prizes/prize-card/PrizeCard.tsx` | L1-35 |
| `src/db/models/punch-cards/punch-cards.ts` | L1-9 |
| `src/db/models/punch-cards/punch-cards.ts` | L74-88 |
| `src/types/schemas.ts` | L55-67 |
| `src/features/users/index.ts` | L1-2 |
| `src/db/models/punch-cards/punch-cards.ts` | L9-17 |
| `src/db/models/punch-cards/punch-cards.ts` | L17-24 |
| `src/db/models/punch-cards/punch-cards.ts` | L65-74 |
| `src/types/schemas.ts` | L74-76 |
| `src/types/api.ts` | L83-90 |
| `src/db/models/punch-cards/punch-cards.ts` | L24-41 |
| `src/features/users/UserScanQrCode.tsx` | L226-286 |
| `src/db/schema.ts` | L198-229 |
| `src/db/models/punch-cards/punch-cards.ts` | L48-65 |
| `src/features/users/UserScanQrCode.tsx` | L1-24 |
| `src/types/api.ts` | L54-60 |
| `src/db/models/prize-redemptions/prize-redemptions.ts` | L29-36 |
| `src/types/schemas.ts` | L67-74 |
| `src/db/models/punch-cards/index.ts` | L1-1 |
| `src/db/models/punch-cards/punch-cards.ts` | L103-107 |
| `src/features/restaurants/Restaurant.tsx` | L1-58 |

</details>

---



Let me check the UserScanQrCode component that's already being used in the profile page:

---

Read file: src/features/users/UserScanQrCode.tsx

---



Now I need to check the UserPunchCard component:

---

Read file: src/features/users/UserPunchCard.tsx

---





Let me check if there's a function to get punch cards with restaurant information:

---

<details>
            <summary>Searched codebase "get punch cards with restaurant information" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/api.ts` | L83-90 |
| `src/db/models/punch-cards/punch-cards.ts` | L41-48 |
| `src/db/models/punch-cards/punch-cards.ts` | L48-65 |
| `src/db/models/punch-cards/punch-cards.ts` | L24-41 |
| `src/app/api/restaurants/[id]/scan/route.ts` | L1-53 |
| `src/features/users/GetUserPunchCard.tsx` | L1-27 |
| `src/types/api.ts` | L116-132 |
| `src/features/restaurants/Restaurant.tsx` | L1-58 |
| `src/types/db.ts` | L28-40 |
| `src/app/api/scan/route.ts` | L1-42 |
| `src/db/schema.ts` | L198-229 |
| `src/db/relations.ts` | L79-92 |
| `src/db/models/punch-cards/punch-cards.ts` | L65-74 |
| `.cursor/rules/prd.mdc` | L112-163 |
| `src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L1-26 |
| `src/types/schemas.ts` | L55-67 |
| `src/db/relations.ts` | L92-97 |
| `drizzle/meta/0002_snapshot.json` | L380-446 |
| `src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L26-92 |
| `drizzle/meta/0001_snapshot.json` | L380-446 |
| `drizzle/meta/0000_snapshot.json` | L380-446 |
| `drizzle/meta/0002_snapshot.json` | L446-480 |
| `src/db/models/punch-cards/punch-cards.ts` | L1-9 |
| `src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L92-121 |
| `src/types/api.ts` | L1-20 |

</details>

---





Now I need to check if there's a function to get all punch cards for a user with restaurant information:

---

<details>
            <summary>Searched codebase "get all punch cards for user with restaurant information" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/db/models/punch-cards/punch-cards.ts` | L48-65 |
| `src/db/models/punch-cards/punch-cards.ts` | L24-41 |
| `src/features/users/GetUserPunchCard.tsx` | L1-27 |
| `src/db/models/punch-cards/punch-cards.ts` | L41-48 |
| `src/db/schema.ts` | L198-229 |
| `src/types/db.ts` | L28-40 |
| `src/db/relations.ts` | L79-92 |
| `src/types/api.ts` | L83-90 |
| `src/app/api/restaurants/[id]/scan/route.ts` | L1-53 |
| `src/app/api/scan/route.ts` | L1-42 |
| `src/db/models/punch-cards/punch-cards.ts` | L65-74 |
| `src/types/schemas.ts` | L55-67 |
| `src/features/restaurants/Restaurant.tsx` | L1-58 |
| `src/types/api.ts` | L116-132 |
| `.cursor/rules/prd.mdc` | L112-163 |
| `src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L1-26 |
| `src/db/models/punch-cards/punch-cards.ts` | L17-24 |
| `src/db/models/punch-cards/punch-cards.ts` | L1-9 |
| `drizzle/meta/0002_snapshot.json` | L380-446 |
| `drizzle/meta/0001_snapshot.json` | L380-446 |
| `drizzle/meta/0002_snapshot.json` | L446-480 |
| `drizzle/meta/0000_snapshot.json` | L380-446 |
| `src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L26-92 |
| `src/types/schemas.ts` | L1-23 |
| `src/features/restaurants/restaurant-detail/RestaurantDetail.tsx` | L92-121 |

</details>

---





I need to create a function to get all punch cards for a user with restaurant information. Let me create this function first:

---

```diff
  import { and, eq } from "drizzle-orm";
  import { db } from "../../db";
- import { punchCards } from "../../schema";
+ import { punchCards, restaurants } from "../../schema";
  
  export const getPunchCards = async () => {
```

```diff
  		.where(eq(punchCards.userId, userId));
  };
+ 
+ export const getPunchCardsByUserIdWithRestaurants = async (userId: bigint) => {
+ 	return await db
+ 		.select({
+ 			id: punchCards.id,
+ 			userId: punchCards.userId,
+ 			restaurantId: punchCards.restaurantId,
+ 			punches: punchCards.punches,
+ 			completed: punchCards.completed,
+ 			updatedAt: punchCards.updatedAt,
+ 			restaurant: {
+ 				id: restaurants.id,
+ 				name: restaurants.name,
+ 				description: restaurants.description,
+ 				imageUrl: restaurants.imageUrl,
+ 				address: restaurants.address,
+ 				qrCodeUrl: restaurants.qrCodeUrl,
+ 			},
+ 		})
+ 		.from(punchCards)
+ 		.innerJoin(restaurants, eq(punchCards.restaurantId, restaurants.id))
+ 		.where(eq(punchCards.userId, userId));
+ };
  
  export const getUserPunchCardForRestaurant = async (
```

---





Now I need to create a component to display the punch cards by restaurant. Let's create a new component:

---

```diff
- 
+ "use client";
+ 
+ import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
+ import { Badge } from "@/components/ui/badge";
+ import { Progress } from "@/components/ui/progress";
+ import Image from "next/image";
+ import Link from "next/link";
+ import { motion } from "framer-motion";
+ 
+ type PunchCardWithRestaurant = {
+   id: bigint;
+   userId: bigint;
+   restaurantId: bigint;
+   punches: number;
+   completed: boolean;
+   updatedAt: string;
+   restaurant: {
+     id: bigint;
+     name: string;
+     description: string;
+     imageUrl: string;
+     address: string;
+     qrCodeUrl: string | null;
+   };
+ };
+ 
+ export function UserPunchCards({ 
+   punchCards 
+ }: { 
+   punchCards: PunchCardWithRestaurant[] 
+ }) {
+   // Default punch threshold (can be made dynamic later)
+   const PUNCH_THRESHOLD = 10;
+ 
+   if (!punchCards || punchCards.length === 0) {
+     return (
+       <Card className="mb-6">
+         <CardHeader>
+           <CardTitle>Your Punch Cards</CardTitle>
+         </CardHeader>
+         <CardContent>
+           <p className="text-muted-foreground">
+             You don't have any punch cards yet. Visit a restaurant to get started!
+           </p>
+         </CardContent>
+       </Card>
+     );
+   }
+ 
+   return (
+     <Card className="mb-6">
+       <CardHeader>
+         <CardTitle>Your Punch Cards</CardTitle>
+       </CardHeader>
+       <CardContent>
+         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
+           {punchCards.map((punchCard) => (
+             <motion.div
+               key={String(punchCard.id)}
+               className="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow"
+               whileHover={{ y: -5 }}
+               initial={{ opacity: 0, y: 20 }}
+               animate={{ opacity: 1, y: 0 }}
+               transition={{ duration: 0.3 }}
+             >
+               <div className="relative h-32 w-full">
+                 <Image
+                   src={punchCard.restaurant.imageUrl}
+                   alt={punchCard.restaurant.name}
+                   fill
+                   className="object-cover"
+                   sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
+                 />
+                 <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
+                 <div className="absolute bottom-2 left-2 right-2">
+                   <h3 className="text-white font-semibold truncate">
+                     {punchCard.restaurant.name}
+                   </h3>
+                   <p className="text-white/80 text-sm truncate">
+                     {punchCard.restaurant.address}
+                   </p>
+                 </div>
+               </div>
+               
+               <div className="p-4">
+                 <div className="flex justify-between items-center mb-2">
+                   <div className="flex items-center gap-2">
+                     <span className="font-medium">Punches: {punchCard.punches}/{PUNCH_THRESHOLD}</span>
+                     {punchCard.completed && (
+                       <Badge variant="success" className="bg-green-100 text-green-800">
+                         Completed
+                       </Badge>
+                     )}
+                   </div>
+                   <span className="text-xs text-gray-500">
+                     Last updated: {new Date(punchCard.updatedAt).toLocaleDateString()}
+                   </span>
+                 </div>
+                 
+                 <Progress 
+                   value={(punchCard.punches / PUNCH_THRESHOLD) * 100} 
+                   className="h-2 mb-3"
+                 />
+                 
+                 <Link 
+                   href={`/restaurants/${punchCard.restaurant.id}`}
+                   className="text-sm text-blue-600 hover:text-blue-800 transition-colors"
+                 >
+                   View Restaurant →
+                 </Link>
+               </div>
+             </motion.div>
+           ))}
+         </div>
+       </CardContent>
+     </Card>
+   );
+ } 
```

---





Let's fix the Badge variant error:

---

```diff
  										{punchCard.completed && (
  											<Badge
- 												variant="success"
+ 												variant="secondary"
  												className="bg-green-100 text-green-800"
  											>
```

---







Now let's create an index.ts file to export the component:

---

```diff
+ export * from "./UserPunchCard";
+ export * from "./UserPunchCards";
  export * from "./UserScanQrCode";
- export * from "./UserPunchCard";
  
```

---







Now let's update the profile page to display the user's punch cards:

---

```diff
- import { UserButton } from "@/components/UserButton";
+ import { UserButton } from "@clerk/nextjs";
+ import { getUserByClerkId } from "@/db/models/users/users";
+ import { auth } from "@clerk/nextjs/server";
  import { UserScanQrCode } from "@/features/users/UserScanQrCode";
- import { getUserByClerkId } from "@/db";
- import { auth } from "@clerk/nextjs/server";
+ import { UserPunchCards } from "@/features/users/UserPunchCards";
+ import { getPunchCardsByUserIdWithRestaurants } from "@/db/models/punch-cards/punch-cards";
+ import { convertBigInts } from "@/lib/utils";
+ 
  export default async function ProfilePage() {
- 	const { userId, sessionClaims } = await auth();
- 
- 	console.log("🚀 ~ ProfilePage ~ userId:", userId);
- 
- 	console.log("🚀 ~ ProfilePage ~ userId:", userId);
+ 	const { userId } = await auth();
  
  	const user = userId ? await getUserByClerkId(userId) : null;
  	console.log("🚀 ~ ProfilePage ~ user:", user);
  
  	if (!user) return <div>Not logged in</div>;
+ 	
+ 	// Fetch user's punch cards with restaurant information
+ 	const punchCards = await getPunchCardsByUserIdWithRestaurants(user.id);
+ 	const serializedPunchCards = convertBigInts(punchCards);
  
  	return (
```

```diff
  				<UserButton />
  			</div>
- 			<div className="bg-white shadow rounded-lg p-6">
+ 			<div className="bg-white shadow rounded-lg p-6 mb-6">
  				<div className="flex items-center space-x-4">
  					<div className="font-medium">
```

```diff
  				</div>
  			</div>
+ 
+ 			{/* Display user's punch cards */}
+ 			<UserPunchCards punchCards={serializedPunchCards} />
+ 			
  			<UserScanQrCode user={user} />
  		</div>
```

---







Let's fix the type error in the UserPunchCards component:

---

```diff
  	userId: bigint;
  	restaurantId: bigint;
- 	punches: number;
- 	completed: boolean;
- 	updatedAt: string;
+ 	punches: number | null;
+ 	completed: boolean | null;
+ 	updatedAt: string | null;
  	restaurant: {
  		id: bigint;
```

```diff
  									<div className="flex items-center gap-2">
  										<span className="font-medium">
- 											Punches: {punchCard.punches}/{PUNCH_THRESHOLD}
+ 											Punches: {punchCard.punches ?? 0}/{PUNCH_THRESHOLD}
  										</span>
  										{punchCard.completed && (
```

```diff
  									<span className="text-xs text-gray-500">
  										Last updated:{" "}
- 										{new Date(punchCard.updatedAt).toLocaleDateString()}
+ 										{new Date(punchCard.updatedAt ?? "").toLocaleDateString()}
  									</span>
  								</div>
  
  								<Progress
- 									value={(punchCard.punches / PUNCH_THRESHOLD) * 100}
+ 									value={((punchCard.punches ?? 0) / PUNCH_THRESHOLD) * 100}
  									className="h-2 mb-3"
  								/>
```

---









Let's create a utility function to handle the convertBigInts function if it doesn't exist:

---

<details>
            <summary>Searched codebase "convertBigInts function" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/lib/utils.ts` | L14-32 |
| `src/lib/utils.ts` | L6-10 |
| `src/types/schemas.ts` | L153-163 |
| `src/db/models/point-transfers/point-transfers.ts` | L72-79 |
| `src/db/models/point-transfers/point-transfers.ts` | L7-15 |
| `src/db/models/point-balances/point-balances.ts` | L69-76 |
| `src/db/models/point-balances/point-balances.ts` | L30-43 |
| `src/db/models/point-transfers/point-transfers.ts` | L34-41 |
| `src/types/db.ts` | L115-128 |
| `src/db/models/point-transfers/point-transfers.ts` | L48-58 |
| `src/db/models/point-transfers/point-transfers.ts` | L15-27 |
| `src/db/models/point-balances/point-balances.ts` | L7-15 |
| `src/types/db.ts` | L100-110 |
| `src/db/models/point-transfers/point-transfers.ts` | L58-72 |
| `src/db/models/point-balances/point-balances.ts` | L23-30 |
| `src/types/api.ts` | L69-83 |
| `src/db/models/point-balances/point-balances.ts` | L43-69 |
| `src/lib/utils.ts` | L10-14 |
| `src/db/models/prizes/prizes.ts` | L7-11 |
| `src/db/models/prize-redemptions/prize-redemptions.ts` | L69-76 |
| `src/db/models/prizes/prizes.ts` | L69-73 |
| `src/db/models/point-transfers/point-transfers.ts` | L27-34 |
| `src/db/schema.ts` | L81-109 |
| `src/types/db.ts` | L40-50 |
| `src/db/models/point-balances/point-balances.ts` | L15-23 |

</details>

---







Let's check if the convertBigInts function works with arrays:

---

Read file: src/lib/utils.ts

---









Let's update the convertBigInts function to handle arrays:

---

```diff
  }
  
- export function convertBigInts<T extends Record<string, any>>(
+ export function convertBigInts<T>(
  	obj: T,
  	dataType: "number" | "string" = "number",
  ): T {
- 	return Object.entries(obj).reduce(
- 		(acc, [key, value]) => ({
- 			...acc,
- 			[key]:
- 				typeof value === "bigint"
- 					? dataType === "number"
- 						? Number(value)
- 						: value.toString()
- 					: value,
- 		}),
- 		{} as T,
- 	);
+ 	// Handle arrays
+ 	if (Array.isArray(obj)) {
+ 		return obj.map(item => convertBigInts(item, dataType)) as unknown as T;
+ 	}
+ 	
+ 	// Handle objects
+ 	if (obj && typeof obj === 'object' && !Array.isArray(obj)) {
+ 		return Object.entries(obj).reduce(
+ 			(acc, [key, value]) => ({
+ 				...acc,
+ 				[key]:
+ 					typeof value === "bigint"
+ 						? dataType === "number"
+ 							? Number(value)
+ 							: value.toString()
+ 						: value instanceof Object
+ 						? convertBigInts(value, dataType)
+ 						: value,
+ 			}),
+ 			{} as T,
+ 		);
+ 	}
+ 	
+ 	// Return primitive values as is
+ 	return obj;
  }
  
```

---









Let's fix the linter error in the convertBigInts function:

---

```diff
  	if (obj && typeof obj === "object" && !Array.isArray(obj)) {
  		return Object.entries(obj).reduce(
- 			(acc, [key, value]) => ({
- 				...acc,
- 				[key]:
+ 			(acc, [key, value]) => {
+ 				acc[key as keyof typeof acc] = 
  					typeof value === "bigint"
  						? dataType === "number"
```

```diff
  						: value instanceof Object
  						? convertBigInts(value, dataType)
- 							: value,
- 			}),
+ 						: value;
+ 				return acc;
+ 			},
  			{} as T,
  		);
```

---









Now let's run the application to see if our changes work:

---

Cancelled

---



---

