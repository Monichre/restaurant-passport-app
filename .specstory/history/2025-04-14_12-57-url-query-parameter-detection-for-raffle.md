<!-- Generated by SpecStory -->

# URL Query Parameter Detection for Raffle (2025-04-14 07:57:02)

_**User**_

This component need to add a feature that detects query parameters in the url that directs to the user page in the following format: raffle=true&raffleEntryId=${result?.data?.raffleEntry?.id}. If Raffle is true, and we have a valid raffleEntryId value - we run @getRaffleEntryById and should run a congratualtions raffle entry animation above the Users punch cards

---

_**Assistant**_



---

I'll update the ProfilePage component to detect query parameters for raffle entries and display a congratulations animation when appropriate. Here's the implementation:

---

Read file: src/hooks/use-punch-card-subscription.ts

---

```diff
  import Link from 'next/link'
  import {getPunchCardsByUserId} from '@/db/models/punch-cards'
+ import {getRaffleEntryById} from '@/db/models/raffle-entries/raffle-entries'
+ import {RaffleSuccessAnimation} from '@/components/raffle/RaffleSuccessAnimation'
  
  // Define viewport metadata as per Next.js recommendations
```

```diff
  }
  
- export default async function ProfilePage(props) {
+ type ProfilePageProps = {
+   params: {id: string}
+   searchParams: {raffle?: string; raffleEntryId?: string}
+ }
+ 
+ export default async function ProfilePage({
+   params,
+   searchParams,
+ }: ProfilePageProps) {
    const {userId} = await auth()
  
```

```diff
  
    // Let the client component handle all data fetching with realtime updates
-   const initialPunchCards: PunchCardWithRestaurant[] =
-     await getPunchCardsByUserId(user.id)
+   const initialPunchCards = await getPunchCardsByUserId(user.id)
+ 
+   // Check for raffle query parameters
+   const showRaffleAnimation =
+     searchParams.raffle === 'true' && !!searchParams.raffleEntryId
+ 
+   // Fetch raffle entry if needed
+   const raffleEntry =
+     showRaffleAnimation && searchParams.raffleEntryId
+       ? await getRaffleEntryById(BigInt(searchParams.raffleEntryId))
+       : null
  
    console.log('ðŸš€ ~ ProfilePage ~ initialPunchCards:', initialPunchCards)
```

```diff
          className='w-full h-auto mb-8 mx-auto display-block'
        />
+ 
+       {showRaffleAnimation && raffleEntry && (
+         <RaffleSuccessAnimation raffleEntry={raffleEntry[0]} />
+       )}
+ 
        {/* Display user's punch cards with real-time updates */}
-       <UserPunchCards user={user} initialPunchCards={initialPunchCards} />
+       <UserPunchCards
+         user={user}
+         initialPunchCards={initialPunchCards as PunchCardWithRestaurant[]}
+       />
  
        <Button
```

---

Now I need to create the RaffleSuccessAnimation component:

---

Tool create_directory not found.

---



---



---



---

```bash
npm install canvas-confetti @types/canvas-confetti
```

```
fetti @types/canvas-confettiurant-passport-app liamellis$ npm install canvas-con 
â ¹
```

---

_**User**_

we dont use npm. we use bun

---

_**Assistant**_



---

I'll install the dependencies using bun instead:

---

```bash
bun add canvas-confetti @types/canvas-confetti
```

```
i @types/canvas-confettiestaurant-passport-app liamellis$ bun add canvas-confett 
[0.08ms] ".env.local", ".env"
bun add v1.2.4 (fd9a5ea6)

+ restaurant-passport-app@

installed canvas-confetti@1.9.3
installed @types/canvas-confetti@1.9.0

2 packages installed [1283.00ms]
Liams-MacBook-Pro-2021:restaurant-passport-app liamellis$
```

---

Let me check if the RaffleSuccessAnimation component file is in the correct location:

---

Could not resolve URI: Error: Unable to resolve nonexistent file '/Users/liamellis/Desktop/restaurant-passport-app/src/components/raffle'

---

The directory doesn't seem to exist yet. Let's try creating it and the component again:

---

```bash
mkdir -p src/components/raffle
```

```
Liams-MacBook-Pro-2021:restaurant-passport-app liamellis$ 

```

---

Now, let's create the RaffleSuccessAnimation component:

---

```diff
- 
+ 'use client'
+ 
+ import {useEffect, useState} from 'react'
+ import {motion, AnimatePresence} from 'framer-motion'
+ import confetti from 'canvas-confetti'
+ import {Card} from '@/components/ui/card'
+ 
+ type RaffleEntry = {
+   id: bigint
+   userId: bigint
+   punchCardId: bigint
+   createdAt: string
+ }
+ 
+ type RaffleSuccessAnimationProps = {
+   raffleEntry: RaffleEntry
+ }
+ 
+ export function RaffleSuccessAnimation({
+   raffleEntry,
+ }: RaffleSuccessAnimationProps) {
+   const [isVisible, setIsVisible] = useState(true)
+ 
+   useEffect(() => {
+     // Trigger confetti animation when component mounts
+     const duration = 3000
+     const animationEnd = Date.now() + duration
+     const defaults = {startVelocity: 30, spread: 360, ticks: 60, zIndex: 0}
+ 
+     function randomInRange(min: number, max: number) {
+       return Math.random() * (max - min) + min
+     }
+ 
+     const interval = setInterval(() => {
+       const timeLeft = animationEnd - Date.now()
+ 
+       if (timeLeft <= 0) {
+         return clearInterval(interval)
+       }
+ 
+       const particleCount = 50 * (timeLeft / duration)
+ 
+       // Since particles fall down, start a bit higher than random
+       confetti({
+         ...defaults,
+         particleCount,
+         origin: {x: randomInRange(0.1, 0.3), y: randomInRange(0, 0.2)},
+       })
+       confetti({
+         ...defaults,
+         particleCount,
+         origin: {x: randomInRange(0.7, 0.9), y: randomInRange(0, 0.2)},
+       })
+     }, 250)
+ 
+     // Hide animation after 5 seconds
+     const timer = setTimeout(() => {
+       setIsVisible(false)
+     }, 5000)
+ 
+     return () => {
+       clearInterval(interval)
+       clearTimeout(timer)
+     }
+   }, [])
+ 
+   return (
+     <AnimatePresence>
+       {isVisible && (
+         <motion.div
+           initial={{opacity: 0, scale: 0.5, y: -50}}
+           animate={{opacity: 1, scale: 1, y: 0}}
+           exit={{opacity: 0, scale: 0.5, y: -50}}
+           transition={{duration: 0.5}}
+           className='mb-8'
+         >
+           <Card className='p-8 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-center shadow-xl'>
+             <motion.div
+               animate={{scale: [1, 1.2, 1]}}
+               transition={{repeat: Number.POSITIVE_INFINITY, duration: 2}}
+             >
+               <h2 className='text-2xl font-bold mb-2'>Congratulations! ðŸŽ‰</h2>
+             </motion.div>
+             <p className='text-lg mb-4'>You've been entered into our raffle!</p>
+             <p className='text-sm opacity-90'>
+               Raffle Entry #{raffleEntry.id.toString()} was created on{' '}
+               {new Date(raffleEntry.createdAt).toLocaleDateString()}
+             </p>
+             <div className='mt-4 text-sm'>
+               <p>Good luck! Winners will be announced soon.</p>
+             </div>
+           </Card>
+         </motion.div>
+       )}
+     </AnimatePresence>
+   )
+ }
+ 
```

---

Now let's make sure we have framer-motion installed:

---

```bash
bun add framer-motion
```

```
Liams-MacBook-Pro-2021:restaurant-passport-app liamellis$ bun add framer-motion
[0.06ms] ".env.local", ".env"
bun add v1.2.4 (fd9a5ea6)

+ restaurant-passport-app@

installed framer-motion@12.7.0

8 packages installed [1497.00ms]
Liams-MacBook-Pro-2021:restaurant-passport-app liamellis$
```

---

The implementation should now be complete. Here's a summary of what I've done:

1. Updated the ProfilePage component to detect query parameters (raffle=true&raffleEntryId=xxx) and fetch the raffle entry data
2. Created the RaffleSuccessAnimation component that:
   - Displays a festive congratulations card when a user completes a punch card and enters a raffle
   - Shows confetti animation using canvas-confetti
   - Uses framer-motion for entrance/exit animations and a pulsing effect
   - Automatically hides after 5 seconds
3. Installed the required dependencies using bun:
   - canvas-confetti (and types)
   - framer-motion

The animation will appear at the top of the user's punch cards when they navigate to the profile page with the appropriate query parameters. The confetti animation creates a celebratory effect, and the component will politely disappear after 5 seconds so it doesn't distract from the main content.

---

