<!-- Generated by SpecStory -->

# Display restaurant image in quick view (2025-06-06 13:38:40)

_**User**_

@restaurant-quick-view.tsx should display restaurant's image from the image_url field on the restaurant database model

---

_**Assistant**_



---

I'll help you add the restaurant image to the `restaurant-quick-view.tsx` component. Looking at the code, I can see that the restaurant data should include an `imageUrl` field, and I'll add it to the restaurant info section in the BentoGrid.

---

```diff
  import {QRCodeManager} from '@/app/admin/restaurants/qr-code-manager'
  import {QRCodeGenerator} from '@/components/qr-code/qr-code-generator'
+ import Image from 'next/image'
  
  // Define the BentoItem interface to match the BentoGrid component's expected types
```

```diff
          description: (
            <div className='py-4'>
+             {/* Restaurant Image */}
+             {restaurantData.imageUrl && (
+               <div className='mb-4 relative w-full h-48 rounded-lg overflow-hidden'>
+                 <Image
+                   src={restaurantData.imageUrl}
+                   alt={`${restaurantData.name} restaurant image`}
+                   fill
+                   className='object-cover'
+                   sizes='(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw'
+                 />
+               </div>
+             )}
+ 
              {restaurantData.description || 'No description available'}
              <br />
```

---



---

Perfect! I've successfully added the restaurant image to the `restaurant-quick-view.tsx` component. Here's what I implemented:

## Changes Made:

1. **Added Next.js Image import** for optimized image handling
2. **Added conditional image rendering** in the restaurant info section of the BentoGrid
3. **Positioned the image prominently** at the top of the restaurant description

## Key Features:

- **Conditional rendering**: Only shows the image if `restaurantData.imageUrl` exists
- **Responsive design**: Fixed height (192px) with proper aspect ratio handling
- **Optimized performance**: Uses Next.js Image component with proper `sizes` attribute
- **Good styling**: Rounded corners and proper overflow handling
- **Accessibility**: Descriptive alt text using the restaurant name

The restaurant image will now display prominently in the quick view dialog, showing at the top of the restaurant information card in the BentoGrid layout. The image is properly optimized and will maintain visual consistency with the rest of the component design.

---

_**User**_

Make the image editable and updatable so that admins can upload a new restaurant image to be used using the @storage.ts you can review docs @StorageModule.md 

---

_**Assistant**_



---

I'll make the restaurant image editable and updatable in the quick view component using the storage module. This will allow admins to upload new restaurant images directly from the quick view interface.

---

```diff
  'use client'
  
- import {useCallback, useEffect, useState, type ReactNode} from 'react'
+ import {useCallback, useEffect, useState, useRef, type ReactNode} from 'react'
  import {Button} from '@/components/ui/button'
- import {Eye, Plus} from 'lucide-react'
+ import {Eye, Plus, Upload, Camera, Loader2} from 'lucide-react'
  import {
    createRestaurantDeal,
    getRestaurantByIdWithAll,
+   updateRestaurant,
  } from '@/db/models/restaurants/restaurants'
  import type {Restaurant, Prize, PunchCard, Deal as DbDeal} from '@/types/db'
```

```diff
  import {QRCodeGenerator} from '@/components/qr-code/qr-code-generator'
  import Image from 'next/image'
+ import {
+   uploadRestaurantImage,
+   getPublicUrl,
+   BUCKET_NAMES,
+   validateFileType,
+   validateFileSize,
+   ALLOWED_IMAGE_TYPES,
+   MAX_FILE_SIZE,
+ } from '@/db/storage'
  
  // Define the BentoItem interface to match the BentoGrid component's expected types
```

```diff
      useState<DetailedRestaurant | null>(null)
  
+   // Image upload state
+   const [isUploadingImage, setIsUploadingImage] = useState(false)
+   const [showImageUpload, setShowImageUpload] = useState(false)
+   const fileInputRef = useRef<HTMLInputElement>(null)
+ 
    // Since we might receive either restaurant or restaurantId, initialize properly
    useEffect(() => {
```

```diff
      toast.success('New deal created successfully')
    }
+ 
+   // Handle image file selection
+   const handleImageSelect = () => {
+     fileInputRef.current?.click()
+   }
+ 
+   // Handle image upload
+   const handleImageUpload = async (
+     event: React.ChangeEvent<HTMLInputElement>
+   ) => {
+     const file = event.target.files?.[0]
+     if (!file || !restaurantData) return
+ 
+     // Validate file
+     if (!validateFileType(file, ALLOWED_IMAGE_TYPES)) {
+       toast.error(
+         'Invalid file type. Please upload a JPEG, PNG, WebP, or SVG image.'
+       )
+       return
+     }
+ 
+     if (!validateFileSize(file, MAX_FILE_SIZE)) {
+       toast.error(
+         `File size must be less than ${MAX_FILE_SIZE / (1024 * 1024)}MB`
+       )
+       return
+     }
+ 
+     setIsUploadingImage(true)
+ 
+     try {
+       // Upload image to storage
+       const uploadResult = await uploadRestaurantImage(
+         restaurantData.id.toString(),
+         file,
+         'logo'
+       )
+ 
+       if (!uploadResult.success) {
+         throw new Error(uploadResult.error || 'Failed to upload image')
+       }
+ 
+       // Generate public URL for the uploaded image
+       const imagePath = uploadResult.data?.path
+       if (!imagePath) {
+         throw new Error('No image path returned from upload')
+       }
+ 
+       const imageUrl = getPublicUrl(BUCKET_NAMES.RESTAURANTS, imagePath)
+ 
+       // Update restaurant in database
+       const updateResult = await updateRestaurant(restaurantData.id, {
+         imageUrl: imageUrl,
+       })
+ 
+       if (!updateResult.success) {
+         throw new Error(updateResult.error || 'Failed to update restaurant')
+       }
+ 
+       // Update local state
+       const updatedRestaurant = {
+         ...restaurantData,
+         imageUrl: imageUrl,
+       }
+       setRestaurantData(updatedRestaurant)
+ 
+       // Propagate update to parent if callback exists
+       if (onQRCodeUpdate) {
+         onQRCodeUpdate(updatedRestaurant)
+       }
+ 
+       setShowImageUpload(false)
+       toast.success('Restaurant image updated successfully!')
+     } catch (error) {
+       console.error('Image upload error:', error)
+       toast.error(
+         error instanceof Error ? error.message : 'Failed to upload image'
+       )
+     } finally {
+       setIsUploadingImage(false)
+       // Clear the file input
+       if (fileInputRef.current) {
+         fileInputRef.current.value = ''
+       }
+     }
+   }
  
    // QR code update handler that updates both local state and parent table
```

```diff
          description: (
            <div className='py-4'>
-             {/* Restaurant Image */}
-             {restaurantData.imageUrl && (
-               <div className='mb-4 relative w-full h-48 rounded-lg overflow-hidden'>
+             {/* Restaurant Image with Edit Functionality */}
+             <div className='mb-4 relative w-full h-48 rounded-lg overflow-hidden group'>
+               {restaurantData.imageUrl ? (
+                 <>
                    <Image
                      src={restaurantData.imageUrl}
                      alt={`${restaurantData.name} restaurant image`}
                      fill
-                   className='object-cover'
+                     className='object-cover transition-all duration-200 group-hover:brightness-75'
                      sizes='(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw'
                    />
+                   {/* Upload overlay */}
+                   <div className='absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center'>
+                     <Button
+                       variant='secondary'
+                       size='sm'
+                       onClick={handleImageSelect}
+                       disabled={isUploadingImage}
+                       className='flex items-center gap-2'
+                     >
+                       {isUploadingImage ? (
+                         <Loader2 className='h-4 w-4 animate-spin' />
+                       ) : (
+                         <Camera className='h-4 w-4' />
+                       )}
+                       {isUploadingImage ? 'Uploading...' : 'Change Image'}
+                     </Button>
+                   </div>
+                 </>
+               ) : (
+                 // No image placeholder with upload button
+                 <div className='w-full h-full bg-gray-100 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-50 transition-colors'>
+                   <Camera className='h-8 w-8 text-gray-400 mb-2' />
+                   <Button
+                     variant='ghost'
+                     size='sm'
+                     onClick={handleImageSelect}
+                     disabled={isUploadingImage}
+                     className='text-gray-600'
+                   >
+                     {isUploadingImage ? (
+                       <>
+                         <Loader2 className='h-4 w-4 animate-spin mr-2' />
+                         Uploading...
+                       </>
+                     ) : (
+                       <>
+                         <Upload className='h-4 w-4 mr-2' />
+                         Upload Image
+                       </>
+                     )}
+                   </Button>
                  </div>
                )}
+ 
+               {/* Hidden file input */}
+               <input
+                 ref={fileInputRef}
+                 type='file'
+                 accept={ALLOWED_IMAGE_TYPES.join(',')}
+                 onChange={handleImageUpload}
+                 className='hidden'
+               />
+             </div>
  
              {restaurantData.description || 'No description available'}
```

```diff
  
      return items
-   }, [restaurantData])
+   }, [restaurantData, isUploadingImage])
  
    return (
```

---



---

Now I need to ensure the `updateRestaurant` function exists in the restaurants model. Let me check the current implementation:

---

<details>
            <summary>Grep search for "updateRestaurant" • **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts` | L140 | `export const updateRestaurant = async (` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts` | L170 | `export const updateRestaurantDeal = async (` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts` | L140 | `export const updateRestaurant = async (` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/models/restaurants/restaurants.ts` | L170 | `export const updateRestaurantDeal = async (` |

</details>

---



---

Perfect! The `updateRestaurant` function already exists in the restaurants model. I've successfully implemented the editable image functionality for the restaurant quick view component. Here's what I've added:

## Features Implemented:

### 🖼️ **Interactive Image Display**
- **Existing Image**: Hover overlay with "Change Image" button
- **No Image**: Placeholder with "Upload Image" button
- **Loading States**: Spinner and progress indicators during upload

### 📁 **File Upload Integration**
- Uses the `uploadRestaurantImage()` function from your storage module
- Validates file types (JPEG, PNG, WebP, SVG only)
- Enforces 50MB file size limit
- Generates public URLs for uploaded images

### 🔄 **State Management**
- Updates local restaurant data after successful upload
- Propagates changes to parent component via callback
- Updates database with new image URL
- Maintains sync between UI and backend

### ⚠️ **Error Handling**
- Client-side file validation before upload
- Toast notifications for success/error states
- Comprehensive error logging
- Graceful failure handling

### 🎨 **User Experience**
- Smooth hover transitions and visual feedback
- Hidden file input for clean UI
- Loading states with spinner animations
- Clear visual indicators for interactive elements

## How It Works:

1. **Click to Upload**: Admin clicks the image area or upload button
2. **File Selection**: Native file picker opens (filtered to image types)
3. **Validation**: Client-side validation for type and size
4. **Upload**: File uploads to Supabase storage via storage module
5. **Update Database**: Restaurant record updated with new image URL
6. **UI Refresh**: Image displays immediately with new URL
7. **Propagation**: Changes sync with parent table component

The implementation seamlessly integrates with your existing storage infrastructure and follows the established patterns in your codebase. Admins can now easily update restaurant images directly from the quick view interface!

---

_**User**_

ons.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/build/swc/index.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/build/next-config-ts/transpile-config.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/server/config.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/server/next.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/server/lib/start-server.js
    at __webpack_require__.f.require (.next/server/webpack-runtime.js:208:28)
    at <unknown> (.next/server/webpack-runtime.js:116:40)
    at Array.reduce (<anonymous>)
    at __webpack_require__.e (.next/server/webpack-runtime.js:115:67)
    at Array.map (<anonymous>)
    at __webpack_require__.X (.next/server/webpack-runtime.js:167:22)
    at <unknown> (.next/server/app/_not-found/page.js:1:2570)
    at Object.<anonymous> (.next/server/app/_not-found/page.js:1:2640) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [Array]
}
 ⨯ Error: Cannot find module './80.js'
Require stack:
- /Users/liamellis/Desktop/restaurant-passport-app/.next/server/webpack-runtime.js
- /Users/liamellis/Desktop/restaurant-passport-app/.next/server/app/_not-found/page.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/server/require.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/server/load-components.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/build/utils.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/build/swc/options.js
- /Users/liamellis/Desktop/restaurant-passport-app/node_modules/next/dist/build/swc/index.js

---

_**Assistant**_



---

This is a common Next.js build error related to webpack chunks not being found. Let's resolve this step by step:

---

```bash
cd /Users/liamellis/Desktop/restaurant-passport-app && rm -rf .next
```

```
aurant-passport-app && rm -rf .next             cd /Users/liamellis/Desktop/restaurant-passport
-app && rm -rf .next
❯ cd /Users/liamellis/Desktop/restaurant-passport-app && rm -rf .next

    ~/Des/restaurant-passport-app  on   main *5 !3 ?6          ✔  at 02:05:35 PM  
(MORE)
```

---



---

```bash
cd /Users/liamellis/Desktop/restaurant-passport-app && npm run dev
```

---



---

Let me check if there are any import issues with the storage module:

---

Read file: src/db/storage.ts

---



---

<details>
            <summary>Listed directory src/db/storage • **4** results</summary>
        
| Name |
|-------|
| 📄 `index.ts` |
| 📄 `storage-client.ts` |
| 📄 `storage-server.ts` |
| 📄 `storage-types.ts` |

</details>

---



---

I found the issue! The storage module is trying to import from a nested `storage/` directory that doesn't exist. Let me fix the import paths in the main storage file:

---



---



---

Let me check the exact file structure:

---

<details>
            <summary>Listed directory src/db • **7** results</summary>
        
| Name |
|-------|
| 📄 `storage.ts` |
| 📁 `storage` |
| 📄 `db.ts` |
| 📁 `supabase` |
| 📁 `models` |
| 📄 `index.ts` |
| 📁 `drizzle` |

</details>

---



---

<details>
            <summary>Grep search for "uploadRestaurantImage" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L96 | `export const uploadRestaurantImage = async (` |

</details>

---



---

<details>
            <summary>Grep search for "BUCKET_NAMES|ALLOWED_IMAGE_TYPES|MAX_FILE_SIZE|validateFileType|validateFileSize|getPublicUrl" • **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L9 | `BUCKET_NAMES,` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L10 | `ALLOWED_IMAGE_TYPES,` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L12 | `validateFileType,` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L13 | `validateFileSize,` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L30 | `if (!validateFileSize(file)) {` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L38 | `if (bucket === BUCKET_NAMES.RESTAURANTS && !validateFileType(file, ALLOWED_IMAGE_TYPES)) {` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L82 | `export const getPublicUrl = (bucket: BucketName, path: string): string => {` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L90 | `.getPublicUrl(normalizedPath);` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-client.ts` | L105 | `return uploadFileClient(BUCKET_NAMES.RESTAURANTS, path, file, {` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-types.ts` | L41 | `export const BUCKET_NAMES: Record<string, BucketName> = {` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-types.ts` | L46 | `export const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-types.ts` | L47 | `export const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml'];` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-types.ts` | L84 | `export const validateFileType = (file: File, allowedTypes: string[]): boolean => {` |
| `file:///Users/liamellis/Desktop/restaurant-passport-app/src/db/storage/storage-types.ts` | L88 | `export const validateFileSize = (file: File, maxSize: number = MAX_FILE_SIZE): boolean => {` |

</details>

---



---

The issue appears to be a webpack chunk resolution problem. Let's try to restart the development server properly:

---

```bash
cd /Users/liamellis/Desktop/restaurant-passport-app && pkill -f "next"
```

```
❯ cd /Users/liamellis/Desktop/restaurant-passport-app && pkill -f "next"

    ~/Des/restaurant-passport-app  on   main *5 !3 ?6  
(MORE)

    ~/Des/restaurant-passport-app  on   main *5 !3 ?6          ✔  at 02:06:41 PM  
```

---



---

```bash
cd /Users/liamellis/Desktop/restaurant-passport-app && rm -rf .next && npm run dev
```

---

_**User**_

use bun

---

_**Assistant**_



---

```bash
pkill -f "next"
```

```
❯ pkill -f "next"



    ~/Des/restaurant-passport-app  on   main *5 !3 ?6  
(MORE)

    ~/Des/restaurant-passport-app  on   main *5 !3 ?6        1 ✘  at 02:07:32 PM  
```

---



---

