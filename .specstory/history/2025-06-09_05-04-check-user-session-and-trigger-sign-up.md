<!-- Generated by SpecStory -->

# Check user session and trigger sign up (2025-06-09 00:04:47)

_**User**_

Check if there is a Clerk session or User and use browser or navigation history to try to determine if theyve landed on the the current route 'restaurants/[id]' from scanning a QR code with their camera from outside the app (should be no navigation history) and then trigger a relevaant message and sign up

---

_**Assistant**_

Here’s a step-by-step plan to implement the requested QR onboarding logic for the `/restaurants/[id]` route in your Next.js app, following your rules and the detailed QR onboarding flow in your Cursor Rules context.

---

## Step-by-Step Plan

1. **Detect if the user is authenticated (Clerk session/user) on the client.**
   - Use Clerk’s `useUser` or `useAuth` hook in a client component.

2. **Determine if the user landed on this page by scanning a QR code:**
   - If there is **no navigation history** (i.e., `window.history.length === 1`), it’s likely a direct entry (e.g., from a QR scan or direct link).
   - Optionally, check for a `ref` or `qr` query param for extra robustness.

3. **If unauthenticated and direct entry:**
   - Show a branded modal/banner:  
     “Welcome! You scanned a code for [Restaurant Name]. Sign up to start earning rewards at this restaurant.”
   - Provide prominent **Sign Up** and **Sign In** buttons (using Clerk’s UI).

4. **Preserve context for signup:**
   - Store the `restaurantId` (from the route param) in `localStorage` or as a query param for the signup flow.
   - After signup, check for this context and trigger onboarding reward logic.

5. **If authenticated, show normal restaurant detail.**

---

## Pseudocode

**Filename:** `QrOnboarding_PSEUDOCODE.md`

```markdown
# QR Onboarding for /restaurants/[id] Route

## 1. Client-Side Detection
- Use a client component to:
  - Get Clerk user/session (useUser/useAuth)
  - Get router params (restaurantId)
  - Check window.history.length === 1 (direct entry)
  - Optionally, check for query param (e.g., ?qr=1)

## 2. If Unauthenticated and Direct Entry
- Show modal/banner:
  - "Welcome! You scanned a code for [Restaurant Name]. Sign up to start earning rewards."
  - Sign Up and Sign In buttons (Clerk)
- Store restaurantId in localStorage/sessionStorage

## 3. On Successful Signup
- Check for stored restaurantId context
- Call backend API to award onboarding reward (badge, points, punch card)
- Redirect to restaurant detail or punch card

## 4. If Authenticated
- Show normal restaurant detail

## 5. Edge Cases
- If restaurantId is invalid, show error
- If already signed up, show normal flow
```

---

## Implementation Plan

1. **Create a client component** (e.g., `QrOnboardingGate.tsx`) in `src/features/restaurants/restaurant-detail/`.
2. **Use Clerk’s `useUser`** to check authentication.
3. **Use Next.js `useRouter`** to get params and navigation state.
4. **On mount:**
   - If unauthenticated and `window.history.length === 1`, show modal/banner.
   - Store `restaurantId` in localStorage/sessionStorage.
5. **On signup completion:**
   - Check for stored `restaurantId` and call onboarding API.
6. **Integrate the component** at the top of `RestaurantDetail`.

---

## Next Steps

1. **Write the pseudocode file** (`QrOnboarding_PSEUDOCODE.md`).
2. **Implement the client component** (`QrOnboardingGate.tsx`).
3. **Document the implementation** in `QrOnboarding.md`.

---

**Proceeding to write the pseudocode file.**

---

```diff
- 
+ # QR Onboarding for /restaurants/[id] Route
+ 
+ ## 1. Client-Side Detection
+ - Create a client component (QrOnboardingGate)
+ - On mount:
+   - Use Clerk's `useUser` or `useAuth` to check if user is authenticated
+   - Use Next.js `useRouter` to get `restaurantId` from params
+   - Check if `window.history.length === 1` (direct entry, likely from QR scan)
+   - Optionally, check for a query param (e.g., ?qr=1) for robustness
+ 
+ ## 2. If Unauthenticated and Direct Entry
+ - Show a modal or banner:
+   - Message: "Welcome! You scanned a code for [Restaurant Name]. Sign up to start earning rewards."
+   - Display Sign Up and Sign In buttons (Clerk UI)
+ - Store `restaurantId` in localStorage or sessionStorage for context preservation
+ - Optionally, log the scan event via API (POST /api/qr/scan)
+ 
+ ## 3. On Successful Signup
+ - After signup, check for stored `restaurantId` context
+ - If present:
+   - Call backend API (POST /api/qr/signup-complete) with `{ restaurantId }` to award onboarding reward (badge, points, punch card)
+   - Optionally, remove the context from storage
+   - Redirect user to the restaurant detail or punch card page
+ 
+ ## 4. If Authenticated
+ - Show normal restaurant detail content (no modal/banner)
+ 
+ ## 5. Edge Cases
+ - If `restaurantId` is invalid or missing, show an error and allow generic signup
+ - If user is already signed up and scans again, show normal flow
+ - Prevent duplicate rewards for the same user/restaurant
+ - Handle abandoned signups (no reward until signup completes) 
```

---

The pseudocode for the QR onboarding logic is now written in `QrOnboarding_PSEUDOCODE.md`. Here’s a summary of the next steps for implementation:

---

### Next Steps

1. **Create a client component** (e.g., `QrOnboardingGate.tsx`) in `src/features/restaurants/restaurant-detail/`:
   - Checks Clerk session/user.
   - Detects direct entry (likely QR scan) via `window.history.length === 1`.
   - Shows a modal/banner with sign up/sign in if unauthenticated and direct entry.
   - Stores `restaurantId` context for onboarding reward.

2. **Integrate the component** at the top of `RestaurantDetail` so it runs on every restaurant detail page.

3. **On signup completion**, check for stored context and call the onboarding reward API.

4. **Document the implementation** in `QrOnboarding.md` after coding.

---

Would you like to proceed with the implementation of the `QrOnboardingGate.tsx` component, or do you want to review or adjust the pseudocode first?

---

_**User**_

use @TriggerSignUp.tsx 

---

_**Assistant**_

Great! Since you want to use `@TriggerSignUp.tsx` for this QR onboarding logic, here’s how we’ll proceed:

---

## Step-by-Step Plan

1. **Enhance `TriggerSignUp.tsx`** to:
   - Detect if the user is unauthenticated and landed directly (likely from a QR scan).
   - Show a modal/banner prompting sign up, with context about the restaurant.
   - Store the `restaurantId` in localStorage/sessionStorage for onboarding reward after signup.
   - Optionally, log the scan event.

2. **Integrate `TriggerSignUp`** into the `RestaurantDetail` page/component so it runs on every restaurant detail view.

3. **On successful signup**, check for stored context and trigger onboarding reward logic.

---

## Detailed Pseudocode for `TriggerSignUp.tsx`

**Filename:** `TriggerSignUp_PSEUDOCODE.md`

```markdown
# TriggerSignUp.tsx Pseudocode

- Import Clerk's useSession (or useUser/useAuth)
- Import Next.js useRouter
- Get restaurantId from router params
- On mount:
  - If user is not signed in AND window.history.length === 1:
    - Show modal/banner: "Welcome! You scanned a code for [Restaurant Name]. Sign up to start earning rewards."
    - Store restaurantId in localStorage/sessionStorage
    - Optionally, POST to /api/qr/scan to log event
- On sign up completion (handled by Clerk):
  - Check for stored restaurantId
  - If present, POST to /api/qr/signup-complete to award reward
  - Remove restaurantId from storage
  - Redirect to restaurant detail or punch card page
- If user is signed in, render nothing (or null)
```

---

## Implementation Plan

1. **Update `TriggerSignUp.tsx`**:
   - Add logic for direct entry detection and modal/banner display.
   - Use Clerk’s sign up/sign in UI.
   - Store context in localStorage/sessionStorage.

2. **Integrate into `RestaurantDetail`**:
   - Place `<TriggerSignUp />` at the top of the component.

3. **Document the implementation** in `TriggerSignUp.md`.

---

**Next, I will write the pseudocode file for `TriggerSignUp.tsx`.**

---

```diff
- 
+ # TriggerSignUp.tsx Pseudocode
+ 
+ - Import Clerk's useSession (or useUser/useAuth)
+ - Import Next.js useRouter
+ - Get restaurantId from router params
+ - On mount:
+   - If user is not signed in AND window.history.length === 1:
+     - Show modal/banner: "Welcome! You scanned a code for [Restaurant Name]. Sign up to start earning rewards."
+     - Store restaurantId in localStorage/sessionStorage
+     - Optionally, POST to /api/qr/scan to log event
+ - On sign up completion (handled by Clerk):
+   - Check for stored restaurantId
+   - If present, POST to /api/qr/signup-complete to award reward
+   - Remove restaurantId from storage
+   - Redirect to restaurant detail or punch card page
+ - If user is signed in, render nothing (or null) 
```

---

The pseudocode for `TriggerSignUp.tsx` is now written in `src/app/(public)/restaurants/[id]/TriggerSignUp_PSEUDOCODE.md`.

**Next steps:**
1. Update `TriggerSignUp.tsx` to implement the described logic:
   - Detect unauthenticated direct entry (likely QR scan).
   - Show a modal/banner with sign up prompt and restaurant context.
   - Store `restaurantId` in localStorage/sessionStorage.
   - On signup completion, trigger onboarding reward and redirect.

2. Integrate `<TriggerSignUp />` at the top of your `RestaurantDetail` page/component.

Would you like me to proceed with the implementation of `TriggerSignUp.tsx` based on this plan?

---

_**User**_

yes. proceed

---

_**Assistant**_



---



---

