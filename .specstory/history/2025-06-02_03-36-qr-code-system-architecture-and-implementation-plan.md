<!-- Generated by SpecStory -->

# Qr code system architecture and implementation plan (2025-06-01 22:36:51)

_**User**_


## QR Code System Architecture: Authentication Flow & State Management

### Part 1: Current State Analysis
**Document the existing QR code scan functionality from an authenticated app user's perspective, including:**
- Current scan-to-action workflows
- Data captured during scans
- State management approach
- Badge/reward system integration
- Technical architecture (APIs, data flow, storage)

### Part 2: Implementation Plan Request
**Design a comprehensive architecture for the following user journey:**

**Scenario:** Unauthenticated user scans a QR code generated by an authenticated app user

**Required Flow:**
1. **QR Code Generation** (by authenticated user)
   - What data should be encoded?
   - How to generate unique, trackable identifiers?

2. **Scan by Unauthenticated User**
   - Cross-platform detection (various QR readers)
   - Redirect to web application signup page

3. **State Preservation**
   - Maintain scan context through signup process
   - Temporary token/ID system for tracking
   - Security considerations for state management

4. **Signup Completion & Reward**
   - Successful account creation triggers
   - First restaurant badge fulfillment
   - Data reconciliation between scan and new account

### Part 3: Technical Requirements
**Address these architectural considerations:**
- URL structure and parameter handling
- Token expiration and security
- Cross-platform compatibility
- Error handling and edge cases
- Analytics and tracking requirements
- Database schema implications

**Deliverable:** Step-by-step implementation plan with technical specifications, API endpoints, and data flow diagrams.


---

_**Assistant**_

Here’s a comprehensive analysis and implementation plan for the QR code system, focusing on both the current authenticated-user flow and the requested unauthenticated-user referral journey. This is structured for clarity and direct use by another senior engineer or AI agent.

---

# QR Code System Architecture: Current State & Referral Flow

---

## Part 1: **Current State Analysis**

### 1. **Scan-to-Action Workflow**

**Actors:**  
- Authenticated app user (User, Restaurant Admin, System Admin)

**Flow:**
1. **User opens QR scanner** (`NavScanner` component).
2. **Scans QR code** (typically restaurant-specific, e.g., `/restaurants/:id/scan`).
3. **`handleScan`** in `NavScanner` calls `processQrScan` server action with `{ qrData, userId }`.
4. **Server Action (`processQrScan`)**:
   - Parses QR data, extracts restaurant ID.
   - Resolves user (by Clerk ID or DB ID).
   - Checks/creates punch card, increments punches.
   - If punch card completes, creates raffle entry.
   - Returns result object: `{ message, data, restaurantName, isExisting, success }`.
5. **Client State:**
   - `result` state holds server response.
   - UI displays success/failure, badge, and triggers redirect after delay.

**APIs Involved:**
- `/api/restaurants/[id]/scan` (for direct API)
- `processQrScan` (server action, used by client)
- DB models: `users`, `restaurants`, `punch_cards`, `raffle_entries`

---

### 2. **Data Captured During Scans**
- **QR Data:** Encoded URL or JSON (e.g., `/restaurants/123/scan`)
- **User ID:** From session/context
- **Restaurant ID:** Parsed from QR
- **Punch Card State:** Created or incremented
- **Raffle Entry:** Created if punch card completes
- **Analytics:** (Not fully shown, but can be logged at each step)

---

### 3. **State Management Approach**
- **Client:** React state (`useState` for `result`, `pause`, etc.)
- **Server:** Stateless, all state persisted in DB (punch cards, raffle entries)
- **Navigation:** Uses Next.js router to redirect after scan
- **Feedback:** UI shows spinner, then result (success/failure, badge, etc.)

---

### 4. **Badge/Reward System Integration**
- **Punch Card Completion:** Triggers raffle entry creation
- **Achievements:** (Planned for point transfers, milestones, etc.)
- **UI Feedback:** Success message, badge icon, redirect to profile/raffle

---

### 5. **Technical Architecture**
- **Frontend:** Next.js, React, Framer Motion, Tailwind, Clerk
- **Backend:** Next.js API routes, Drizzle ORM, Supabase (Postgres)
- **QR Scanning:** `@yudiel/react-qr-scanner` (browser camera)
- **Data Flow:**  
  - QR scan → client action → server action → DB → response → UI update
- **Storage:** All persistent state in Postgres via Drizzle ORM

---

## Part 2: **Referral Flow Implementation Plan**

### **Scenario:**  
*Unauthenticated user scans a QR code generated by an authenticated app user (referral/guest badge system).*

---

### **1. QR Code Generation (by Authenticated User)**

#### **Data to Encode**
- **Referral URL**:  
  `/referral?referrerId=<userId>&restaurantId=<restaurantId>&token=<secureToken>`
- **Fields:**
  - `referrerId`: The authenticated user's unique ID (Clerk or DB)
  - `restaurantId`: The restaurant context (optional, for targeted rewards)
  - `token`: A signed, time-limited JWT or random UUID (for security/tracking)

#### **How to Generate**
- **On demand** (e.g., "Share QR" button in app)
- **Backend endpoint**:  
  - `POST /api/referrals/generate`
  - Payload: `{ referrerId, restaurantId }`
  - Returns: `{ url, token, expiresAt }`
- **Token Generation:**
  - Use JWT or random UUID, store in `referral_tokens` table with metadata and expiration

#### **Example QR Data**
```
https://app.example.com/referral?referrerId=123&restaurantId=456&token=abcdef
```

---

### **2. Scan by Unauthenticated User**

#### **Cross-Platform Detection**
- QR code can be scanned by any QR reader (native camera, 3rd party app, etc.)
- **URL opens in browser** (mobile or desktop)

#### **Redirect to Signup**
- `/referral` route detects unauthenticated user
- Prompts: "Sign up to claim your reward from <referrer/restaurant>!"
- After signup, context is preserved (see next section)

---

### **3. State Preservation**

#### **Maintain Scan Context**
- **Referral token and params** are passed as URL query params
- On landing, store in:
  - **Session/localStorage** (for multi-step signup)
  - **Next.js server session** (if using server-side auth)
- **Token/ID system:**
  - `referral_tokens` table: `{ token, referrerId, restaurantId, createdAt, expiresAt, claimedByUserId, status }`
  - Mark as "claimed" after signup

#### **Security Considerations**
- **Token expiration** (e.g., 24h)
- **Single-use**: Mark as claimed after use
- **Validation**: On signup completion, verify token is valid, not expired, not already claimed
- **No sensitive data** in token (use server-side lookup)

---

### **4. Signup Completion & Reward**

#### **Trigger on Account Creation**
- After successful signup, check for referral context (token in session)
- **Backend endpoint**:  
  - `POST /api/referrals/claim`
  - Payload: `{ token, newUserId }`
  - Validates and marks referral as claimed

#### **Badge Fulfillment**
- Award "First Restaurant" badge or points to new user
- Optionally, reward referrer (e.g., bonus points, achievement)
- **DB updates:**
  - `achievements` table: add badge for new user
  - `point_balances` or `achievements`: update for referrer

#### **Data Reconciliation**
- Link referral record to new user
- Analytics: log conversion, source, etc.

---

## Part 3: **Technical Requirements & Specifications**

### **A. URL Structure & Parameter Handling**
- `/referral?referrerId=...&restaurantId=...&token=...`
- All params required for tracking and validation
- Use Next.js dynamic route: `/app/referral/page.tsx`

### **B. Token Expiration & Security**
- **JWT** (signed, expiring) or random UUID (stored in DB)
- Expire after 24h (configurable)
- Mark as claimed after use
- Validate on every use (signup, claim)

### **C. Cross-Platform Compatibility**
- QR code encodes HTTPS URL
- Works with any QR reader/camera
- Mobile-first design for landing/signup

### **D. Error Handling & Edge Cases**
- **Invalid/expired token:** Show error, prompt to sign up without reward
- **Already claimed:** Inform user, allow normal signup
- **Missing params:** Show generic error
- **Signup abandoned:** Token remains unclaimed until expiration

### **E. Analytics & Tracking**
- Log:
  - QR code generation (who, when, where)
  - Scan events (IP, device, timestamp)
  - Signup completions (conversion rate)
  - Badge/point fulfillment
- Use Supabase or external analytics (e.g., Vercel Analytics)

### **F. Database Schema Implications**

#### **New Table: `referral_tokens`**
```typescript
export const referralTokens = pgTable("referral_tokens", {
  id: serial("id").primaryKey(),
  token: text("token").notNull().unique(),
  referrerId: integer("referrer_id").references(() => users.id),
  restaurantId: integer("restaurant_id").references(() => restaurants.id),
  createdAt: timestamp("created_at").defaultNow(),
  expiresAt: timestamp("expires_at"),
  claimedByUserId: integer("claimed_by_user_id").references(() => users.id),
  status: text("status").notNull().default("active"), // active, claimed, expired
});
```

#### **API Endpoints**
- `POST /api/referrals/generate` – Authenticated, returns referral URL/token
- `GET /api/referrals/validate?token=...` – Validates token (for landing page)
- `POST /api/referrals/claim` – On signup, claims reward

---

## **Step-by-Step Implementation Plan**

### **1. QR Code Generation**
- Add "Share QR" button for authenticated users
- On click, call `POST /api/referrals/generate`
- Backend creates token, stores in `referral_tokens`, returns URL
- Frontend generates QR code with returned URL

### **2. Referral Landing Page**
- New Next.js route: `/app/referral/page.tsx`
- On load, parse query params, call `/api/referrals/validate`
- If valid, prompt signup; else, show error

### **3. State Preservation**
- On landing, store token/context in localStorage/session
- During signup, pass token/context through steps (or use server session)

### **4. Signup Completion**
- On successful signup, call `/api/referrals/claim` with token and new user ID
- Backend validates, marks referral as claimed, awards badge/points

### **5. Badge/Reward Fulfillment**
- Update `achievements` and/or `point_balances` for new user (and referrer)
- Show confirmation UI

### **6. Analytics**
- Log all relevant events (QR generation, scan, signup, claim)

---

## **Data Flow Diagram**

```mermaid
sequenceDiagram
    participant AuthUser as Authenticated User
    participant App as Web App
    participant UnauthUser as Unauthenticated User
    participant API as Backend API
    participant DB as Database

    AuthUser->>App: Clicks "Share QR"
    App->>API: POST /api/referrals/generate
    API->>DB: Create referral_token
    API-->>App: Returns referral URL
    App->>AuthUser: Shows QR code

    UnauthUser->>App: Scans QR, opens referral URL
    App->>API: GET /api/referrals/validate?token=...
    API->>DB: Validate token
    API-->>App: Token valid/invalid
    App->>UnauthUser: Prompts signup

    UnauthUser->>App: Completes signup
    App->>API: POST /api/referrals/claim
    API->>DB: Mark token claimed, award badge/points
    API-->>App: Success/failure
    App->>UnauthUser: Shows reward
```

---

## **Summary Table: Key Endpoints & Data**

| Endpoint                       | Method | Purpose                        | Auth Required | Params/Body                |
|------------------------------- |--------|------------------------------- |--------------|---------------------------|
| `/api/referrals/generate`      | POST   | Generate referral QR/token     | Yes          | `{referrerId, restaurantId}` |
| `/api/referrals/validate`      | GET    | Validate referral token        | No           | `token` (query)           |
| `/api/referrals/claim`         | POST   | Claim referral after signup    | Yes (new user)| `{token, newUserId}`      |

---

## **Security & Best Practices**
- Use signed tokens (JWT or UUID + DB)
- Expire tokens after short period (24h)
- Mark tokens as claimed after use
- Never expose sensitive data in QR/URL
- Validate all params server-side
- Log all actions for audit/analytics

---

## **Edge Cases & Error Handling**
- Expired/invalid token: Show error, allow normal signup
- Already claimed: Inform, allow normal signup
- Multiple signups with same token: Only first gets reward
- Abandoned signup: Token remains active until expiration

---

## **Analytics & Tracking**
- Track QR generation, scans, signups, claims
- Store in `referral_tokens` and analytics tables
- Use for campaign effectiveness, fraud detection, reward optimization

---

## **Database Schema Changes**
- Add `referral_tokens` table (see above)
- Update `achievements` and `point_balances` logic for referral rewards

---

## **Next Steps**
- Implement backend endpoints and DB schema
- Build frontend QR generation and referral landing/signup flows
- Integrate with existing badge/reward system
- Add analytics and error handling

---

**This plan provides a robust, secure, and extensible architecture for QR-based referrals, supporting both authenticated and unauthenticated user flows, with clear state management, security, and analytics.** If you need code samples or further breakdowns for any step, let me know!

---

_**User**_

OK, we need to update part two of the documentation, the referral flow implementation plan. This is not a referral flow, this is for the use case when a stranger (could be anyone in the world) sees a QR code on the dinner table at the restaurant that they are visiting and they're like "oh, what's this?" The QR code and the requisite logic in the application must be able to support guiding anyone who's not a registered app user to become a registered app user if they scan a QR code in a participating restaurant. 

---

_**Assistant**_

Absolutely—let’s clarify and update the implementation plan for the **public QR onboarding flow** (not a referral, but a general “join the app” experience for any unregistered user who scans a restaurant’s QR code).

---

# Part 2 (Revised): **Public QR Onboarding Flow Implementation Plan**

## **Scenario**
A non-app-user (stranger/guest) scans a QR code displayed at a participating restaurant. The system should:
- Recognize the scan as coming from a public QR code (not a referral or user-generated code).
- Guide the user to sign up for the app, preserving the context of which restaurant’s QR code was scanned.
- Upon signup, optionally grant a “first visit” badge, points, or other onboarding reward, and associate the user with the restaurant for analytics or engagement.

---

## **Step-by-Step Implementation Plan**

### **1. QR Code Generation & Placement**

#### **What Data Should Be Encoded?**
- **URL format:**  
  ```
  https://app.example.com/qr?restaurantId=<restaurantId>&campaign=<optional>
  ```
  - `restaurantId`: Unique identifier for the restaurant.
  - `campaign`: (Optional) For tracking special promotions.

#### **How to Generate?**
- **Admin dashboard**: Restaurant admins or system admins generate QR codes for each location.
- **Backend endpoint**:  
  - `GET /api/qr/generate?restaurantId=...`
  - Returns a QR code image (PNG/SVG) encoding the above URL.
- **Physical placement**: Print and place QR codes on tables, menus, posters, etc.

---

### **2. Scan by Unregistered User**

#### **Cross-Platform Detection**
- Any QR reader (native camera, 3rd party app) opens the encoded URL in a browser.

#### **Landing Page Logic**
- **Route:** `/qr` (Next.js page)
- **Behavior:**
  - If user is **not authenticated**:
    - Show a branded landing page:  
      “Welcome to [App Name]! You scanned a code at [Restaurant Name]. Sign up to start earning rewards.”
    - Prominent **Sign Up** and **Sign In** buttons.
    - Store `restaurantId` (and `campaign` if present) in localStorage, session, or as a query param for the signup flow.
  - If user is **already authenticated**:
    - Optionally, redirect to punch card for that restaurant or show a “Welcome back!” message.

---

### **3. State Preservation Through Signup**

#### **How to Maintain Context?**
- **Store `restaurantId` and `campaign`**:
  - In localStorage/sessionStorage (client-side)
  - Or as a query param passed through the signup flow
- **Signup flow** (Clerk or custom):
  - On successful signup, check for stored `restaurantId`/`campaign` context.

#### **Security Considerations**
- No sensitive data in QR or URL.
- Validate `restaurantId` on backend before granting rewards.
- Optionally, set a short-lived cookie or session value for extra robustness.

---

### **4. Signup Completion & Reward**

#### **On Account Creation**
- **Backend logic** (triggered post-signup):
  - Check for `restaurantId` context.
  - Award “First Visit” badge, points, or other onboarding reward.
  - Optionally, create a punch card for the restaurant.
  - Log the event for analytics (user, restaurant, campaign, timestamp).

#### **Data Reconciliation**
- Link the new user to the restaurant for analytics.
- Optionally, send a welcome notification or email.

---

## **Technical Requirements & Specifications**

### **A. URL Structure & Parameter Handling**
- `/qr?restaurantId=123&campaign=spring2024`
- All params validated server-side.
- Use Next.js dynamic route: `/app/qr/page.tsx`

### **B. Token Expiration & Security**
- No sensitive tokens needed; only public IDs.
- Validate `restaurantId` exists and is active.
- Prevent abuse (e.g., rate limit badge/point grants per user).

### **C. Cross-Platform Compatibility**
- QR code encodes HTTPS URL.
- Works with any QR reader/camera.
- Mobile-first, responsive landing page.

### **D. Error Handling & Edge Cases**
- **Invalid/missing `restaurantId`**: Show error, allow generic signup.
- **Already signed up user scans**: Show punch card or “already a member” message.
- **Signup abandoned**: No reward granted until signup completes.

### **E. Analytics & Tracking**
- Log:
  - QR code scans (IP, device, timestamp, restaurant, campaign)
  - Signups from QR flow (conversion rate)
  - Badge/point fulfillment
- Use for campaign effectiveness, restaurant engagement, etc.

### **F. Database Schema Implications**

#### **No new tables required** (unless you want to track scans separately).  
- Optionally, add a `qr_signup_source` or `last_qr_scan_restaurant_id` field to the `users` table for attribution.
- Log events in an `analytics` or `qr_scan_events` table for deeper insights.

---

## **API Endpoints**

| Endpoint                       | Method | Purpose                        | Auth Required | Params/Body                |
|------------------------------- |--------|------------------------------- |--------------|---------------------------|
| `/api/qr/generate`             | GET    | Generate QR code for restaurant| Yes (admin)  | `restaurantId`, `campaign`|
| `/api/qr/scan`                 | POST   | Log scan event                 | No           | `{restaurantId, campaign, deviceInfo}`|
| `/api/qr/signup-complete`      | POST   | Award badge/points post-signup | Yes (new user)| `{restaurantId, campaign}`|

---

## **Data Flow Diagram**

```mermaid
sequenceDiagram
    participant Guest as Unregistered User
    participant QR as QR Code
    participant App as Web App
    participant API as Backend API
    participant DB as Database

    Guest->>QR: Scans QR code
    QR-->>App: Opens /qr?restaurantId=123
    App->>API: POST /api/qr/scan (log event)
    App->>Guest: Shows signup prompt (with restaurant context)
    Guest->>App: Completes signup
    App->>API: POST /api/qr/signup-complete
    API->>DB: Award badge/points, create punch card
    App->>Guest: Shows welcome/reward
```

---

## **Summary Table: Key Endpoints & Data**

| Endpoint                       | Method | Purpose                        | Auth Required | Params/Body                |
|------------------------------- |--------|------------------------------- |--------------|---------------------------|
| `/api/qr/generate`             | GET    | Generate QR code for restaurant| Yes (admin)  | `restaurantId`, `campaign`|
| `/api/qr/scan`                 | POST   | Log scan event                 | No           | `{restaurantId, campaign, deviceInfo}`|
| `/api/qr/signup-complete`      | POST   | Award badge/points post-signup | Yes (new user)| `{restaurantId, campaign}`|

---

## **Security & Best Practices**
- No sensitive data in QR/URL.
- Validate all params server-side.
- Prevent duplicate rewards for same user/restaurant.
- Log all actions for analytics.

---

## **Edge Cases & Error Handling**
- Invalid/missing `restaurantId`: Show error, allow generic signup.
- Already registered user: Show punch card or “already a member” message.
- Multiple signups from same device: Prevent abuse.

---

## **Analytics & Tracking**
- Track scans, signups, reward fulfillment.
- Attribute new users to restaurants/campaigns.

---

## **Database Schema Changes (Optional)**
- Add `qr_signup_source` to `users` table.
- Add `qr_scan_events` table for analytics.

---

## **Next Steps**
- Implement QR code generation and admin UI.
- Build `/qr` landing page and signup flow.
- Integrate reward logic post-signup.
- Add analytics and error handling.

---

**This plan ensures a seamless, secure, and trackable onboarding experience for any guest who scans a restaurant QR code, driving app adoption and engagement.**  
Let me know if you want code samples, DB migration scripts, or further breakdowns for any step!

---

_**User**_

Can  you create a step by step implementation plan and instructions to hand off to both AI and human software agents to complete the Part 2 (Revised): Public QR Onboarding Flow Implementation Plan feature? 

---

