<!-- Generated by SpecStory -->

# Get User Raffle Entries Implementation (2025-04-13 21:04:08)

_**User**_

We need to add get user raffle entries here

---

_**Assistant**_



---

I'll implement the functionality to display user raffle entries in the UserPunchCards component. First, I need to search for the existing punch card subscription hook to understand how data is being fetched.

---

<details>
            <summary>Searched codebase "usePunchCardSubscription implementation" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/hooks/use-punch-card-subscription.ts` | L74-137 |
| `src/features/users/UserPunchCardSubscription.tsx` | L1-6 |
| `src/hooks/use-punch-card-subscription.ts` | L24-74 |
| `src/hooks/use-punch-card-subscription.ts` | L1-24 |
| `src/hooks/index.ts` | L10-11 |
| `src/features/users/UserPunchCards.tsx` | L1-12 |
| `src/features/users/UserPunchCard.tsx` | L1-14 |
| `src/features/users/UserPunchCards.tsx` | L17-52 |
| `src/features/users/GetUserPunchCard.tsx` | L1-27 |
| `src/components/ui/punchcard.tsx` | L130-138 |
| `src/features/users/lottery-status.tsx` | L1-43 |
| `src/db/models/punch-cards/punch-cards.ts` | L92-109 |
| `src/db/models/punch-cards/punch-cards.ts` | L52-69 |
| `src/db/models/punch-cards/punch-cards.ts` | L28-45 |
| `src/components/ui/restaurant-punch-card.tsx` | L1-23 |
| `src/db/models/punch-cards/punch-cards.ts` | L1-9 |
| `src/types/db.ts` | L43-57 |
| `src/db/models/punch-cards/punch-cards.ts` | L9-19 |
| `src/db/models/punch-cards/punch-cards.ts` | L78-92 |
| `src/db/models/punch-cards/punch-cards.ts` | L19-28 |
| `src/app/users/[id]/profile/page.tsx` | L1-17 |
| `src/components/ui/restaurant-specific-user-punch-card.tsx` | L205-248 |
| `src/db/models/users/users.ts` | L47-64 |
| `src/components/ui/restaurant-punch-card.tsx` | L23-67 |
| `src/components/ui/restaurant-specific-user-punch-card.tsx` | L167-205 |

</details>

---

Now, let me check the raffle entries model/database to understand how to access raffle entries:

---

<details>
            <summary>Searched codebase "raffle entries model or database" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/db.ts` | L57-67 |
| `src/db/drizzle/schema.ts` | L105-130 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L29-36 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L1-7 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L7-15 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L15-22 |
| `src/types/api.ts` | L174-187 |
| `.cursor/rules/repo.mdc` | L717-770 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L22-29 |
| `drizzle/meta/0000_snapshot.json` | L110-175 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L36-43 |
| `src/db/drizzle/meta/0003_snapshot.json` | L502-567 |
| `src/db/drizzle/meta/0002_snapshot.json` | L480-545 |
| `src/db/drizzle/meta/0004_snapshot.json` | L502-567 |
| `src/app/api/raffle-entries/route.ts` | L1-50 |
| `src/db/models/leaderboard/leaderboard.ts` | L63-94 |
| `src/db/drizzle/meta/0001_snapshot.json` | L480-545 |
| `src/db/drizzle/relations.ts` | L40-51 |
| `src/db/drizzle/meta/0000_snapshot.json` | L480-545 |
| `.cursor/rules/prd.mdc` | L112-163 |
| `scripts/example_prd.txt` | L101-155 |
| `README.md` | L107-158 |
| `src/db/models/index.ts` | L3-4 |
| `src/db/models/raffle-entries/index.ts` | L1-1 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L99-142 |

</details>

---

I need to check if there's an API endpoint for raffle entries:

---

<details>
            <summary>Searched codebase "api raffle entries" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `src/app/api/raffle-entries/route.ts` | L1-50 |
| `src/types/api.ts` | L174-187 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L1-7 |
| `src/types/db.ts` | L57-67 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L29-36 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L7-15 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L15-22 |
| `src/db/drizzle/schema.ts` | L105-130 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L22-29 |
| `src/db/models/leaderboard/leaderboard.ts` | L63-94 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L36-43 |
| `src/hooks/useRaffleEntriesSubscription.tsx` | L1-44 |
| `src/app/api/restaurants/[id]/scan/route.ts` | L88-126 |
| `.cursor/rules/repo.mdc` | L717-770 |
| `src/app/admin/leaderboard/page.tsx` | L107-127 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L1-30 |
| `drizzle/meta/0000_snapshot.json` | L110-175 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L30-62 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L99-142 |
| `src/db/drizzle/meta/0003_snapshot.json` | L502-567 |
| `src/db/drizzle/relations.ts` | L40-51 |
| `src/hooks/useRaffleEntriesSubscription.tsx` | L44-73 |
| `src/db/drizzle/meta/0004_snapshot.json` | L502-567 |

</details>

---

Let me check if there's an existing API endpoint specifically for user raffle entries:

---

<details>
            <summary>Searched codebase "api user raffle entries" • **23** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/api.ts` | L174-187 |
| `src/app/api/raffle-entries/route.ts` | L1-50 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L1-7 |
| `src/db/models/leaderboard/leaderboard.ts` | L63-94 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L15-22 |
| `src/types/db.ts` | L57-67 |
| `src/db/drizzle/schema.ts` | L105-130 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L29-36 |
| `src/app/api/restaurants/[id]/scan/route.ts` | L88-126 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L7-15 |
| `src/app/admin/leaderboard/page.tsx` | L107-127 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L1-30 |
| `src/hooks/useRaffleEntriesSubscription.tsx` | L1-44 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L22-29 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L30-62 |
| `.cursor/rules/repo.mdc` | L717-770 |
| `src/db/models/raffle-entries/raffle-entries.ts` | L36-43 |
| `src/db/drizzle/relations.ts` | L40-51 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L99-142 |
| `src/db/models/leaderboard/leaderboard.ts` | L1-36 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L142-183 |
| `drizzle/meta/0000_snapshot.json` | L110-175 |
| `src/components/admin/leaderboard/admin-raffle-entries.tsx` | L62-99 |

</details>

---

Now that I have a better understanding of how raffle entries work in the system, I need to:

1. Create a hook to get raffle entries with subscriptions similar to `usePunchCardSubscription`
2. Add this to the UserPunchCards component to display raffle entries

First, I'll create a new hook to fetch raffle entries by user ID with real-time subscription:

---

```diff
- 
+ "use client";
+ 
+ import { useState, useEffect, useCallback } from "react";
+ import type { RaffleEntry } from "@/types/db";
+ import { supabaseBrowserClient } from "@/db/supabase/supabase.client";
+ 
+ export type RaffleEntryWithRestaurant = RaffleEntry & {
+ 	restaurant?: {
+ 		id: bigint;
+ 		name: string;
+ 		imageUrl: string;
+ 		address: string;
+ 	};
+ };
+ 
+ /**
+  * A hook for subscribing to real-time raffle entry updates
+  * @param userId The user ID to subscribe to raffle entries for
+  * @returns The updated raffle entries array
+  */
+ export function useRaffleEntriesSubscription(userId: bigint) {
+ 	const [raffleEntries, setRaffleEntries] = useState<
+ 		RaffleEntryWithRestaurant[]
+ 	>([]);
+ 	const [isLoading, setIsLoading] = useState(true);
+ 	const [error, setError] = useState<Error | null>(null);
+ 
+ 	const fetchRaffleEntries = useCallback(async () => {
+ 		try {
+ 			setIsLoading(true);
+ 
+ 			// Use the client-side API endpoint to get raffle entries
+ 			const response = await fetch(`/api/raffle-entries?userId=${userId}`);
+ 
+ 			if (!response.ok) {
+ 				throw new Error("Failed to fetch raffle entries");
+ 			}
+ 
+ 			const { success, data, error } = await response.json();
+ 
+ 			if (!success) {
+ 				throw new Error(error || "Failed to fetch raffle entries");
+ 			}
+ 
+ 			setRaffleEntries(data);
+ 		} catch (err) {
+ 			console.error("Error fetching raffle entries:", err);
+ 			setError(
+ 				err instanceof Error ? err : new Error("Unknown error occurred"),
+ 			);
+ 		} finally {
+ 			setIsLoading(false);
+ 		}
+ 	}, [userId]);
+ 
+ 	// Fetch initial raffle entries
+ 	useEffect(() => {
+ 		if (userId) {
+ 			fetchRaffleEntries();
+ 		}
+ 	}, [userId, fetchRaffleEntries]);
+ 
+ 	// Set up real-time subscription
+ 	useEffect(() => {
+ 		if (!userId) return;
+ 
+ 		// Convert bigint to string for the subscription
+ 		const userIdStr = userId.toString();
+ 
+ 		// Subscribe to raffle entry changes for this user
+ 		const subscription = supabaseBrowserClient
+ 			.channel("raffle-entries")
+ 			.on(
+ 				"postgres_changes",
+ 				{
+ 					event: "*", // Listen to all events (insert, update, delete)
+ 					schema: "public",
+ 					table: "raffle_entries",
+ 					filter: `user_id=eq.${userIdStr}`,
+ 				},
+ 				async () => {
+ 					try {
+ 						// Refresh the data using the API endpoint
+ 						await fetchRaffleEntries();
+ 					} catch (err) {
+ 						console.error("Error updating raffle entries:", err);
+ 					}
+ 				},
+ 			)
+ 			.subscribe();
+ 
+ 		// Clean up subscription on unmount
+ 		return () => {
+ 			subscription.unsubscribe();
+ 		};
+ 	}, [userId, fetchRaffleEntries]);
+ 
+ 	return {
+ 		raffleEntries,
+ 		isLoading,
+ 		error,
+ 	};
+ }
+ 
```

---

Now I need to create an API endpoint for fetching raffle entries by user ID:

---

```diff
  import { NextResponse } from "next/server";
- import { getRaffleEntries } from "@/db/models/raffle-entries";
+ import {
+ 	getRaffleEntries,
+ 	getRaffleEntriesByUserId,
+ } from "@/db/models/raffle-entries";
  import { db } from "@/db/db";
  import { restaurants, punchCards } from "@/db/drizzle/schema";
  import { sql } from "drizzle-orm";
  
- export async function GET() {
+ export async function GET(request: Request) {
  	try {
- 		// Fetch raffle entries with joined data using the model function
- 		const raffleEntriesData = await getRaffleEntries();
- 
- 		// If we need restaurant information, we need to fetch it separately
- 		// since the basic getRaffleEntries() doesn't include relations
- 		const entriesWithDetails = await db.query.raffleEntries.findMany({
+ 		const { searchParams } = new URL(request.url);
+ 		const userId = searchParams.get("userId");
+ 
+ 		let entriesWithDetails;
+ 
+ 		if (userId) {
+ 			// Fetch raffle entries for specific user
+ 			const userIdBigInt = BigInt(userId);
+ 			entriesWithDetails = await db.query.raffleEntries.findMany({
+ 				where: (raffleEntries, { eq }) =>
+ 					eq(raffleEntries.userId, userIdBigInt),
+ 				with: {
+ 					punchCard: {
+ 						with: {
+ 							restaurant: true,
+ 						},
+ 					},
+ 					user: true,
+ 				},
+ 			});
+ 		} else {
+ 			// Fetch all raffle entries
+ 			entriesWithDetails = await db.query.raffleEntries.findMany({
  				with: {
  					punchCard: {
```

```diff
  				},
  			});
+ 		}
  
  		// Transform the data for the UI
  		const formattedData = entriesWithDetails.map((entry) => ({
  			id: entry.id,
+ 			userId: entry.userId,
+ 			punchCardId: entry.punchCardId,
+ 			createdAt: entry.createdAt,
  			name: `Raffle Entry #${entry.id}`,
  			description: `Created at ${new Date(entry.createdAt).toLocaleString()} for punch card ${entry.punchCardId}`,
  			imageUrl: "/images/raffle-placeholder.jpg", // Default image since we don't have prize info
- 			restaurantId: entry.punchCard.restaurantId,
- 			restaurant: entry.punchCard.restaurant || {
- 				id: 0,
+ 			restaurant: entry.punchCard?.restaurant || {
+ 				id: BigInt(0),
  				name: "Unknown Restaurant",
  				description: "",
```

---

Now I'll expose the hook in the hooks index file:

---

```diff
  export * from "./use-websocket";
  export * from "./use-punch-card-subscription";
+ export * from "./use-raffle-entries-subscription";
  
```

---

Now I'll update the UserPunchCards component to show the user's raffle entries:

---

```diff
    type PunchCardWithRestaurant,
  } from '@/hooks/use-punch-card-subscription'
+ import {
+   useRaffleEntriesSubscription,
+   type RaffleEntryWithRestaurant,
+ } from '@/hooks/use-raffle-entries-subscription'
  
  type User = {
```

```diff
    // Start with initial data from server, then get real-time updates
    const {punchCards, isLoading, error} = usePunchCardSubscription(user.id)
+   const {raffleEntries} = useRaffleEntriesSubscription(user.id)
  
    // If we have realtime data, use it, otherwise use the initial data
```

```diff
          </div>
        </div>
-       <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
-         
+       <div className='mt-4'>
+         <div className='text-sm font-medium mb-2'>
+           Your Raffle Entries: {raffleEntries.length}
+         </div>
+         {raffleEntries.length > 0 && (
+           <div className='p-4 bg-blue-50 rounded-lg mb-4'>
+             <h3 className='font-medium text-blue-800 mb-2'>Raffle Entries</h3>
+             <ul className='space-y-2'>
+               {raffleEntries.map((entry) => (
+                 <li
+                   key={String(entry.id)}
+                   className='flex items-center text-sm'
+                 >
+                   <span className='inline-block w-3 h-3 bg-blue-500 rounded-full mr-2'></span>
+                   Entry from {entry.restaurant?.name || 'Unknown Restaurant'} on{' '}
+                   {new Date(entry.createdAt).toLocaleDateString()}
+                 </li>
+               ))}
+             </ul>
+           </div>
+         )}
        </div>
        <div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
```

---

I've successfully implemented the functionality to show user raffle entries in the UserPunchCards component. Here's what I did:

1. Created a new hook `useRaffleEntriesSubscription` that:
   - Fetches raffle entries for a specific user from the API
   - Sets up real-time subscription to raffle entry changes via Supabase
   - Returns the entries, loading state, and any errors

2. Enhanced the existing API endpoint at `/api/raffle-entries` to:
   - Support filtering by user ID via query parameters
   - Return formatted data that includes restaurant information

3. Updated the UserPunchCards component to:
   - Use the new hook to fetch and display raffle entries
   - Show a count of entries and a list with entry details
   - Maintain all existing punch card functionality

Now users will see their raffle entries displayed in a nice blue section with details about when and where each entry was created. The information updates in real-time thanks to the Supabase subscription.

---

