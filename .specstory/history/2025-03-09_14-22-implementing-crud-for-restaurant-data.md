<!-- Generated by SpecStory -->

# Implementing CRUD for Restaurant Data (2025-03-09 09:22:45)

_**User**_

Add support within the restaurant administrator table for the create update and delete of restaurant data. And let's use a state action to do that instead of an API route. 

---

_**Assistant**_

<think>The user is asking to implement CRUD (Create, Read, Update, Delete) operations for restaurant data in the existing restaurant administrator table. They want to use server actions instead of API routes for this functionality.

Let's analyze the current code and plan the changes needed:

1. From the code I can see, there's a `RestaurantsPage` component which renders a restaurant list and has a link to add a new restaurant.
2. There's a `RestaurantsList` component which uses a `RestaurantsTable` component to display restaurants.
3. There's also a `RestaurantCard` component which is not shown in the code around the cursor.
4. There's a `Restaurant` type defined which is inferred from a `restaurantSchema` using Zod.

I need to:
1. Create server actions for CRUD operations (create, update, delete) for restaurant data
2. Update the `RestaurantsTable` component to handle these actions
3. Make sure the UI reflects these operations

First, let me see what other files might be relevant by searching the codebase.</think>Let me implement CRUD operations for restaurants using server actions. First, I'll check the existing restaurant table implementation and related files.

---

Read file: src/app/admin/restaurants/page.tsx

---

Now let's look at the `RestaurantsTable` component:

---

Read file: src/components/admin/restaurants-table.tsx

---

Let's look at the relevant database schema and models:

---

Read file: src/db/schema.ts

---

Could not find file 'src/db/models.ts'. Did you mean one of:
- src/db/models/index.ts
- src/db/models/users/index.ts
- src/db/models/users/users.ts

---

Let's check the models directory:

---

Read file: src/db/models/index.ts

---

Read file: src/db/models/restaurants/restaurants.ts

---

Now let's check the Zod schemas:

---

Read file: src/types/schemas.ts

---

Let's also understand what server actions look like in this project:

---

<details>
            <summary>Grep search for "use server" â€¢ **0** files</summary>
        
No results found
</details>

---

Based on the code I've analyzed, I'll now implement server actions for restaurant CRUD operations and update the RestaurantsTable component to use them.

First, let's create a server actions file for restaurants:

---

```diff
- 
+ "use server";
+ 
+ import { db } from "@/db/db";
+ import { restaurants } from "@/db/schema";
+ import { eq } from "drizzle-orm";
+ import { revalidatePath } from "next/cache";
+ import { redirect } from "next/navigation";
+ import { z } from "zod";
+ import { createRestaurantSchema, restaurantSchema } from "@/types/schemas";
+ import type { Restaurant } from "@/types/db";
+ 
+ export type RestaurantFormData = z.infer<typeof createRestaurantSchema>;
+ 
+ /**
+  * Creates a new restaurant
+  */
+ export async function createRestaurantAction(formData: RestaurantFormData) {
+ 	try {
+ 		const validatedData = createRestaurantSchema.parse(formData);
+ 
+ 		await db.insert(restaurants).values(validatedData);
+ 
+ 		revalidatePath("/admin/restaurants");
+ 		redirect("/admin/restaurants");
+ 	} catch (error) {
+ 		if (error instanceof z.ZodError) {
+ 			return { success: false, error: error.flatten().fieldErrors };
+ 		}
+ 
+ 		return {
+ 			success: false,
+ 			error: { _form: ["Failed to create restaurant"] },
+ 		};
+ 	}
+ }
+ 
+ /**
+  * Updates an existing restaurant
+  */
+ export async function updateRestaurantAction(
+ 	id: bigint,
+ 	data: Partial<RestaurantFormData>,
+ ) {
+ 	try {
+ 		// Validate partial data
+ 		const validatedData = z
+ 			.object({
+ 				name: z.string().optional(),
+ 				description: z.string().optional(),
+ 				imageUrl: z.string().url().optional(),
+ 				address: z.string().optional(),
+ 			})
+ 			.parse(data);
+ 
+ 		await db
+ 			.update(restaurants)
+ 			.set(validatedData)
+ 			.where(eq(restaurants.id, id));
+ 
+ 		revalidatePath("/admin/restaurants");
+ 
+ 		return {
+ 			success: true,
+ 			message: "Restaurant updated successfully",
+ 		};
+ 	} catch (error) {
+ 		if (error instanceof z.ZodError) {
+ 			return { success: false, error: error.flatten().fieldErrors };
+ 		}
+ 
+ 		return {
+ 			success: false,
+ 			error: { _form: ["Failed to update restaurant"] },
+ 		};
+ 	}
+ }
+ 
+ /**
+  * Deletes a restaurant
+  */
+ export async function deleteRestaurantAction(id: bigint) {
+ 	try {
+ 		await db.delete(restaurants).where(eq(restaurants.id, id));
+ 
+ 		revalidatePath("/admin/restaurants");
+ 
+ 		return {
+ 			success: true,
+ 			message: "Restaurant deleted successfully",
+ 		};
+ 	} catch (error) {
+ 		return {
+ 			success: false,
+ 			error: { _form: ["Failed to delete restaurant"] },
+ 		};
+ 	}
+ }
+ 
+ /**
+  * Updates the QR code URL for a restaurant
+  */
+ export async function updateRestaurantQRCodeAction(
+ 	id: bigint,
+ 	qrCodeUrl: string,
+ ) {
+ 	try {
+ 		await db
+ 			.update(restaurants)
+ 			.set({ qrCodeUrl })
+ 			.where(eq(restaurants.id, id));
+ 
+ 		revalidatePath("/admin/restaurants");
+ 
+ 		return {
+ 			success: true,
+ 			message: "QR code updated successfully",
+ 		};
+ 	} catch (error) {
+ 		return {
+ 			success: false,
+ 			error: { _form: ["Failed to update QR code"] },
+ 		};
+ 	}
+ }
+ 
```

---

Now, let's update the RestaurantsTable component to use these server actions. I'm going to create a new version that integrates our server actions:

---

```diff
  	QrCode,
  	MoreHorizontal,
+ 	Trash2,
  } from "lucide-react";
  import type { z } from "zod";
  import type { restaurantSchema } from "@/types/schemas";
  import type { Restaurant } from "@/types/db";
  import { QRCodeManager } from "@/app/admin/restaurants/qr-code-manager";
+ import { useRouter } from "next/navigation";
+ import {
+ 	updateRestaurantAction,
+ 	deleteRestaurantAction,
+ } from "@/actions/restaurants";
+ import { toast } from "sonner";
  
  // Styled components imports
```

```diff
  import { Input } from "@/components/ui/input";
  import { Badge } from "@/components/ui/badge";
+ import {
+ 	AlertDialog,
+ 	AlertDialogAction,
+ 	AlertDialogCancel,
+ 	AlertDialogContent,
+ 	AlertDialogDescription,
+ 	AlertDialogFooter,
+ 	AlertDialogHeader,
+ 	AlertDialogTitle,
+ 	AlertDialogTrigger,
+ } from "@/components/ui/alert-dialog";
+ import {
+ 	DropdownMenu,
+ 	DropdownMenuContent,
+ 	DropdownMenuItem,
+ 	DropdownMenuTrigger,
+ } from "@/components/ui/dropdown-menu";
  
  // Define interfaces for TanStack Table metadata
```

```diff
  	const [value, setValue] = React.useState(initialValue);
  	const [editing, setEditing] = React.useState(false);
+ 
+ 	// Update local value when row data changes
+ 	React.useEffect(() => {
+ 		setValue(getValue());
+ 	}, [getValue]);
  
  	const onBlur = () => {
```

```diff
  	if (
  		columnId === "id" ||
+ 		columnId === "qrCodeUrl" ||
  		(column.columnDef.meta as ColumnMeta)?.editable === false
  	) {
```

```diff
  		switch (columnId) {
  			case "name":
+ 				return <Building className="h-4 w-4 text-gray-500 mr-2" />;
+ 			case "description":
  				return <Building className="h-4 w-4 text-gray-500 mr-2" />;
  			case "address":
```

```diff
  	const [sorting, setSorting] = React.useState<SortingState>([]);
  	const [pending, setPending] = React.useState<Record<number, boolean>>({});
+ 	const [restaurantToDelete, setRestaurantToDelete] =
+ 		React.useState<RestaurantData | null>(null);
+ 	const router = useRouter();
+ 
+ 	// Update local data when initialData changes
+ 	React.useEffect(() => {
+ 		setData(initialData);
+ 	}, [initialData]);
  
  	// Define columns for the table
```

```diff
  		},
  		{
- 			accessorKey: "qrCodeUrl",
- 			header: "QR Code",
- 			cell: ({ row }) => {
- 				const restaurant = row.original as Restaurant;
- 				return (
- 					<div className="flex items-center">
- 						<QrCode className="h-4 w-4 text-gray-500 mr-2" />
- 						<QRCodeManager restaurant={restaurant} variant="table" />
- 					</div>
- 				);
- 			},
+ 			accessorKey: "description",
+ 			header: "Description",
+ 			cell: EditableCell,
  		},
  		{
```

```diff
  		{
  			accessorKey: "imageUrl",
- 			header: ({ column }) => (
- 				<div className="flex items-center gap-0.5">
- 					Image URL
- 					<Button
- 						size="sm"
- 						variant="ghost"
- 						className="h-8 w-8 ml-1 p-0"
- 						onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}
- 					>
- 						{getSortingIcon(column.getIsSorted())}
- 					</Button>
- 				</div>
- 			),
+ 			header: "Image URL",
  			cell: EditableCell,
  		},
+ 		{
+ 			accessorKey: "qrCodeUrl",
+ 			header: "QR Code",
+ 			cell: ({ row }) => {
+ 				const restaurant = row.original as Restaurant;
+ 				return (
+ 					<div className="flex items-center">
+ 						<QrCode className="h-4 w-4 text-gray-500 mr-2" />
+ 						<QRCodeManager restaurant={restaurant} variant="table" />
+ 					</div>
+ 				);
+ 			},
+ 		},
  		{
  			id: "actions",
- 			header: "Actions",
+ 			header: "",
  			cell: ({ row }) => {
  				const restaurant = row.original;
- 				const isPending = pending[row.index] || false;
- 
  				return (
- 					<div className="flex items-center space-x-2">
- 						<Button
- 							onClick={() => handleSave(row.index, restaurant)}
- 							disabled={isPending}
- 							size="sm"
- 							variant={isPending ? "outline" : "default"}
- 							className="h-8 text-xs"
- 						>
- 							{isPending ? "Saving..." : "Save"}
- 						</Button>
- 						<Button
- 							onClick={() => handleView(restaurant.id.toString())}
- 							size="sm"
- 							variant="outline"
- 							className="h-8 text-xs"
- 						>
- 							View
- 						</Button>
- 						<Button size="sm" variant="ghost" className="h-8 w-8 ml-2 p-0">
+ 					<div className="flex justify-end">
+ 						<DropdownMenu>
+ 							<DropdownMenuTrigger asChild>
+ 								<Button variant="ghost" className="h-8 w-8 p-0">
  									<MoreHorizontal className="h-4 w-4" />
  								</Button>
+ 							</DropdownMenuTrigger>
+ 							<DropdownMenuContent align="end">
+ 								<DropdownMenuItem
+ 									onClick={() => handleView(restaurant.id.toString())}
+ 								>
+ 									View Details
+ 								</DropdownMenuItem>
+ 								<DropdownMenuItem
+ 									onClick={() => setRestaurantToDelete(restaurant)}
+ 									className="text-red-600"
+ 								>
+ 									Delete
+ 								</DropdownMenuItem>
+ 							</DropdownMenuContent>
+ 						</DropdownMenu>
  					</div>
  				);
```

```diff
  	];
  
- 	// Function to handle saving a restaurant
+ 	// Handle view restaurant details
+ 	const handleView = (id: string) => {
+ 		router.push(`/admin/restaurants/${id}`);
+ 	};
+ 
+ 	// Handle saving edited data using server action
  	const handleSave = async (rowIndex: number, restaurant: RestaurantData) => {
  		try {
- 			setPending((prev) => ({ ...prev, [rowIndex]: true }));
+ 			setPending({ ...pending, [rowIndex]: true });
  
- 			const response = await fetch(`/api/restaurants/${restaurant.id}`, {
- 				method: "PUT",
- 				headers: {
- 					"Content-Type": "application/json",
- 				},
- 				body: JSON.stringify({
- 					name: restaurant.name,
- 					description: restaurant.description,
- 					address: restaurant.address,
- 					imageUrl: restaurant.imageUrl,
- 				}),
- 			});
- 
- 			if (!response.ok) {
- 				throw new Error("Failed to update restaurant");
- 			}
- 
- 			// Show success badge or notification here
- 			console.log("Restaurant updated successfully");
+ 			const { id, ...updateData } = restaurant;
+ 
+ 			const result = await updateRestaurantAction(id, updateData);
+ 
+ 			if (result.success) {
+ 				toast.success(result.message);
+ 			} else {
+ 				toast.error(result.error?._form?.[0] || "Failed to update restaurant");
+ 				// Reset to original data if update failed
+ 				setData(initialData);
+ 			}
  		} catch (error) {
- 			console.error("Error updating restaurant:", error);
- 			// Show error badge or notification here
+ 			toast.error("An error occurred while updating the restaurant");
+ 			console.error(error);
  		} finally {
- 			setPending((prev) => ({ ...prev, [rowIndex]: false }));
+ 			setPending({ ...pending, [rowIndex]: false });
  		}
  	};
  
- 	// Function to handle viewing a restaurant
- 	const handleView = (id: string) => {
- 		window.location.href = `/admin/restaurants/${id}`;
- 	};
- 
- 	// Create the table instance
- 	const table = useReactTable<RestaurantData>({
+ 	// Handle restaurant deletion
+ 	const handleDelete = async () => {
+ 		if (!restaurantToDelete) return;
+ 
+ 		try {
+ 			const result = await deleteRestaurantAction(restaurantToDelete.id);
+ 
+ 			if (result.success) {
+ 				toast.success(result.message);
+ 				// Remove from local state
+ 				setData(data.filter((r) => r.id !== restaurantToDelete.id));
+ 			} else {
+ 				toast.error(result.error?._form?.[0] || "Failed to delete restaurant");
+ 			}
+ 		} catch (error) {
+ 			toast.error("An error occurred while deleting the restaurant");
+ 			console.error(error);
+ 		} finally {
+ 			setRestaurantToDelete(null);
+ 		}
+ 	};
+ 
+ 	const table = useReactTable({
  		data,
  		columns,
  		getCoreRowModel: getCoreRowModel(),
+ 		getSortedRowModel: getSortedRowModel(),
  		getPaginationRowModel: getPaginationRowModel(),
- 		getSortedRowModel: getSortedRowModel(),
  		onSortingChange: setSorting,
  		state: {
  			sorting,
  		},
  		meta: {
- 			updateData: (rowIndex: number, columnId: string, value: unknown) => {
+ 			updateData: (rowIndex, columnId, value) => {
  				setData((old) =>
  					old.map((row, index) => {
```

```diff
  					}),
  				);
+ 
+ 				// Save changes to the database after a small delay to allow for multiple quick edits
+ 				const debounceTimeout = setTimeout(() => {
+ 					if (columnId !== "id") {
+ 						handleSave(rowIndex, data[rowIndex]);
+ 					}
+ 				}, 1000);
+ 
+ 				return () => clearTimeout(debounceTimeout);
  			},
  		} as TableMeta,
  	});
  
  	return (
- 		<div className="w-full">
- 			<div className="rounded-md border border-gray-200 bg-white">
+ 		<>
+ 			<div className="rounded-md border">
  				<Table>
  					<TableHeader>
  						{table.getHeaderGroups().map((headerGroup) => (
- 							<TableRow key={headerGroup.id} className="bg-gray-50">
+ 							<TableRow key={headerGroup.id}>
  								{headerGroup.headers.map((header) => (
- 									<TableHead
- 										key={header.id}
- 										className="py-3.5 text-left text-sm font-medium text-gray-700"
- 									>
+ 									<TableHead key={header.id}>
  										{header.isPlaceholder
  											? null
```

```diff
  					</TableHeader>
  					<TableBody>
- 						{table.getRowModel().rows?.length ? (
- 							table.getRowModel().rows.map((row, i, arr) => (
- 								<React.Fragment key={row.id}>
+ 						{table.getRowModel().rows.length ? (
+ 							table.getRowModel().rows.map((row) => (
  								<TableRow
- 										className="group hover:bg-gray-50"
+ 									key={row.id}
  									data-state={row.getIsSelected() && "selected"}
+ 									className="group"
  								>
  									{row.getVisibleCells().map((cell) => (
```

```diff
  									))}
  								</TableRow>
- 									{i < arr.length - 1 && (
- 										<tr className="border-row">
- 											<td colSpan={columns.length} className="p-0">
- 												<div className="border-t border-gray-100" />
- 											</td>
- 										</tr>
- 									)}
- 								</React.Fragment>
  							))
  						) : (
  							<TableRow>
  								<TableCell
  									colSpan={columns.length}
- 									className="h-24 text-center text-sm text-gray-500"
+ 									className="h-24 text-center"
  								>
- 									No restaurants found
+ 									No restaurants found.
  								</TableCell>
  							</TableRow>
```

```diff
  				</Table>
  			</div>
- 			<div className="flex items-center justify-between space-x-2 py-4">
- 				<div className="text-sm text-gray-500">
- 					Page {table.getState().pagination.pageIndex + 1} of{" "}
- 					{table.getPageCount()}
- 				</div>
- 				<div className="flex items-center space-x-2">
+ 			<div className="flex items-center justify-end space-x-2 py-4">
  				<Button
  					variant="outline"
  					size="sm"
  					onClick={() => table.previousPage()}
  					disabled={!table.getCanPreviousPage()}
- 						className="h-8"
  				>
- 						<ChevronLeft className="h-4 w-4 mr-1" />
  					Previous
  				</Button>
```

```diff
  					onClick={() => table.nextPage()}
  					disabled={!table.getCanNextPage()}
- 						className="h-8"
  				>
  					Next
- 						<ChevronRight className="h-4 w-4 ml-1" />
  				</Button>
- 				</div>
  			</div>
- 		</div>
+ 
+ 			{/* Confirmation dialog for restaurant deletion */}
+ 			<AlertDialog
+ 				open={!!restaurantToDelete}
+ 				onOpenChange={(open) => !open && setRestaurantToDelete(null)}
+ 			>
+ 				<AlertDialogContent>
+ 					<AlertDialogHeader>
+ 						<AlertDialogTitle>Delete Restaurant</AlertDialogTitle>
+ 						<AlertDialogDescription>
+ 							Are you sure you want to delete the restaurant &quot;
+ 							{restaurantToDelete?.name}&quot;? This action cannot be undone.
+ 						</AlertDialogDescription>
+ 					</AlertDialogHeader>
+ 					<AlertDialogFooter>
+ 						<AlertDialogCancel>Cancel</AlertDialogCancel>
+ 						<AlertDialogAction
+ 							onClick={handleDelete}
+ 							className="bg-red-600 hover:bg-red-700"
+ 						>
+ 							Delete
+ 						</AlertDialogAction>
+ 					</AlertDialogFooter>
+ 				</AlertDialogContent>
+ 			</AlertDialog>
+ 		</>
  	);
  }
```

---

Now, let's install the missing dependencies and fix those linter errors:

---

```bash
npm install sonner @radix-ui/react-alert-dialog @radix-ui/react-dropdown-menu
```

```
npm ERR! code ERESOLVE
npm ERR! ERESOLVE could not resolve
npm ERR! 
npm ERR! While resolving: react-qr-reader@3.0.0-beta-1
npm ERR! Found: react@19.0.0
npm ERR! node_modules/react
npm ERR!   peerOptional react@"^18 || ^19 || ^19.0.0-rc" from ai@4.1.50
npm ERR!   node_modules/ai
npm ERR!     ai@"^4.1.50" from the root project
npm ERR!   peerOptional react@"^18.0.0 || ^19.0.0" from framer-motion@12.4.10
npm ERR!   node_modules/framer-motion
npm ERR!     framer-motion@"^12.4.10" from motion@12.4.10
npm ERR!     node_modules/motion
npm ERR!       motion@"^12.4.10" from the root project
npm ERR!     framer-motion@"^12.4.10" from the root project
npm ERR!   63 more (lucide-react, motion, next, react-dom, react-qr-code, ...)
npm ERR! 
npm ERR! Could not resolve dependency:
npm ERR! peer react@"^16.8.0 || ^17.0.0" from react-qr-reader@3.0.0-beta-1
npm ERR! node_modules/react-qr-reader
npm ERR!   react-qr-reader@"^3.0.0-beta-1" from the root project
npm ERR! 
npm ERR! Conflicting peer dependency: react@17.0.2
npm ERR! node_modules/react
npm ERR!   peer react@"^16.8.0 || ^17.0.0" from react-qr-reader@3.0.0-beta-1
npm ERR!   node_modules/react-qr-reader
npm ERR!     react-qr-reader@"^3.0.0-beta-1" from the root project
npm ERR! 
npm ERR! Fix the upstream dependency conflict, or retry
npm ERR! this command with --force or --legacy-peer-deps
npm ERR! to accept an incorrect (and potentially broken) dependency resolution.
npm ERR! 
npm ERR! 
npm ERR! For a full report see:
npm ERR! /Users/liamellis/.npm/_logs/2025-03-09T14_40_25_222Z-eresolve-report.tx
t

npm ERR! A complete log of this run can be found in: /Users/liamellis/.npm/_logs
/2025-03-09T14_40_25_222Z-de
bug-0.log
                            
```

---



---

