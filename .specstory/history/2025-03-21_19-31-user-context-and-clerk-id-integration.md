<!-- Generated by SpecStory -->

# User Context and Clerk ID Integration (2025-03-21 14:31:03)

_**User**_

Generate a user context and provider that gets the clerk ID from clerk auth and uses it to query the full user from the database and then sets the context for current user. 

---

_**Assistant**_

```diff
- 
+ // use client
+ 'use client'
+ 
+ import type React from 'react'
+ import {createContext, useContext, useEffect, useState} from 'react'
+ import {useUser as useClerkUser} from '@clerk/nextjs'
+ 
+ // Define the full user type as stored in our DB
+ export type AppUser = {
+   id: number
+   clerkId: string
+   name: string
+   isStaff: boolean
+   isAdmin: boolean
+ }
+ 
+ // Context type with current user, loading state, error and a reload function
+ export type UserContextType = {
+   currentUser: AppUser | null
+   isLoading: boolean
+   error: string | null
+   reloadUser: () => void
+ }
+ 
+ const UserContext = createContext<UserContextType | undefined>(undefined)
+ 
+ export const UserProvider: React.FC<{children: React.ReactNode}> = ({
+   children,
+ }) => {
+   const {user: clerkUser, isLoaded: clerkLoaded} = useClerkUser()
+   const [currentUser, setCurrentUser] = useState<AppUser | null>(null)
+   const [isLoading, setIsLoading] = useState<boolean>(false)
+   const [error, setError] = useState<string | null>(null)
+ 
+   // Function to fetch full user data from the DB using the clerk ID
+   const fetchUser = async (clerkId: string) => {
+     setIsLoading(true)
+     try {
+       const res = await fetch(`/api/users/clerk/${clerkId}`)
+       if (!res.ok) {
+         throw new Error('Failed to fetch user')
+       }
+       const data = await res.json()
+       setCurrentUser(data)
+     } catch (err: any) {
+       setError(err.message)
+     } finally {
+       setIsLoading(false)
+     }
+   }
+ 
+   // When clerk auth is loaded and we have a clerk ID, fetch the full user data
+   useEffect(() => {
+     if (clerkLoaded && clerkUser?.id) {
+       fetchUser(clerkUser.id)
+     }
+   }, [clerkLoaded, clerkUser])
+ 
+   // Allows manual refresh of the full user data
+   const reloadUser = () => {
+     if (clerkUser?.id) {
+       fetchUser(clerkUser.id)
+     }
+   }
+ 
+   return (
+     <UserContext.Provider value={{currentUser, isLoading, error, reloadUser}}>
+       {children}
+     </UserContext.Provider>
+   )
+ }
+ 
+ export const useUserContext = (): UserContextType => {
+   const context = useContext(UserContext)
+   if (!context) {
+     throw new Error('useUserContext must be used within a UserProvider')
+   }
+   return context
+ }
+ 
```

---

```diff
  
  import type React from 'react'
- import {createContext, useContext, useEffect, useState} from 'react'
+ import {
+   createContext,
+   useContext,
+   useEffect,
+   useState,
+   useCallback,
+ } from 'react'
  import {useUser as useClerkUser} from '@clerk/nextjs'
  
```

```diff
    const [error, setError] = useState<string | null>(null)
  
-   // Function to fetch full user data from the DB using the clerk ID
-   const fetchUser = async (clerkId: string) => {
+   // Use useCallback to memoize fetchUser
+   const fetchUser = useCallback(async (clerkId: string) => {
      setIsLoading(true)
      try {
```

```diff
        const data = await res.json()
        setCurrentUser(data)
-     } catch (err: any) {
+     } catch (err) {
+       if (err instanceof Error) {
          setError(err.message)
+       } else {
+         setError('An unknown error occurred')
+       }
      } finally {
        setIsLoading(false)
      }
-   }
+   }, [])
  
    // When clerk auth is loaded and we have a clerk ID, fetch the full user data
```

```diff
        fetchUser(clerkUser.id)
      }
-   }, [clerkLoaded, clerkUser])
+   }, [clerkLoaded, clerkUser, fetchUser])
  
    // Allows manual refresh of the full user data
```

---

Below is the complete code for src/context/user-context.tsx. It uses Clerk auth to retrieve the clerk ID, then queries your API for the full user record, and populates the context accordingly.

```typescript:src/context/user-context.tsx
'use client'

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  useCallback,
} from 'react'
import { useUser as useClerkUser } from '@clerk/nextjs'

// Define the full user type as stored in our DB
export type AppUser = {
  id: number
  clerkId: string
  name: string
  isStaff: boolean
  isAdmin: boolean
}

// Context type with current user, loading state, error and a reload function
export type UserContextType = {
  currentUser: AppUser | null
  isLoading: boolean
  error: string | null
  reloadUser: () => void
}

const UserContext = createContext<UserContextType | undefined>(undefined)

export const UserProvider: React.FC<{ children: React.ReactNode }> = ({
  children,
}) => {
  const { user: clerkUser, isLoaded: clerkLoaded } = useClerkUser()
  const [currentUser, setCurrentUser] = useState<AppUser | null>(null)
  const [isLoading, setIsLoading] = useState<boolean>(false)
  const [error, setError] = useState<string | null>(null)

  // Use useCallback to memoize fetchUser
  const fetchUser = useCallback(async (clerkId: string) => {
    setIsLoading(true)
    try {
      const res = await fetch(`/api/users/clerk/${clerkId}`)
      if (!res.ok) {
        throw new Error('Failed to fetch user')
      }
      const data = await res.json()
      setCurrentUser(data)
    } catch (err) {
      if (err instanceof Error) {
        setError(err.message)
      } else {
        setError('An unknown error occurred')
      }
    } finally {
      setIsLoading(false)
    }
  }, [])

  // When clerk auth is loaded and we have a clerk ID, fetch the full user data
  useEffect(() => {
    if (clerkLoaded && clerkUser?.id) {
      fetchUser(clerkUser.id)
    }
  }, [clerkLoaded, clerkUser, fetchUser])

  // Allows manual refresh of the full user data
  const reloadUser = () => {
    if (clerkUser?.id) {
      fetchUser(clerkUser.id)
    }
  }

  return (
    <UserContext.Provider value={{ currentUser, isLoading, error, reloadUser }}>
      {children}
    </UserContext.Provider>
  )
}

export const useUserContext = (): UserContextType => {
  const context = useContext(UserContext)
  if (!context) {
    throw new Error('useUserContext must be used within a UserProvider')
  }
  return context
}
```

This provider fetches the full user based on the Clerk ID as soon as the Clerk auth is loaded, and it also exposes a reload function so you can re-fetch the user data whenever needed.

---

