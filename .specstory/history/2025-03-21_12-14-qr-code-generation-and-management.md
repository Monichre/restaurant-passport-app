<!-- Generated by SpecStory -->

# QR Code Generation and Management (2025-03-21 07:14:16)

_**User**_

Handle generate function and the general functionality to generate a QR code should not just update Boolean state variables but should generate a new QR code value for the restaurant and then update the existing QR code data image to reflect the latest QR code value. Saving the QR code after generating should save the data image svg to the restaurant if none exists or update the qrCodeUrl field for the restaurant if one does. The option to download the QR code should only be shown after the restaurant has been updated or before outside of the update process. 

---

_**Assistant**_



---

I'll fix the `useHandleQRCode` hook to properly generate QR codes and handle saving/downloading:

---

```diff
  	const [success, setSuccess] = useState(false);
  	const [error, setError] = useState<string | null>(null);
- 	const [qrCodeDataUrl, setQrCodeDataUrl] = useState<string | null>(null);
- 	const [qrCodeValue, setQrCodeValue] = useState<string | null>(restaurant ? `/api/restaurants/${restaurant?.id}/scan` : null);	
+ 	const [qrCodeDataUrl, setQrCodeDataUrl] = useState<string | null>(restaurant.qrCodeUrl || null);
+ 	const [qrCodeValue, setQrCodeValue] = useState<string>(`${getBaseUrl()}/api/restaurants/${restaurant.id}/scan`);	
  	const qrRef = useRef<HTMLDivElement>(null);
  
  	// Get the base URL from environment or window location
- 	const getBaseUrl = () => {
+ 	function getBaseUrl() {
  		if (typeof window !== "undefined") {
  			return window.location.origin;
  		}
  		return process.env.NEXT_PUBLIC_BASE_URL || "";
  	};
- 
- 	// Construct the QR code value with the appropriate base URL
- 	
- 	
  
  	// Generate QR code and show save/cancel buttons
  	const handleGenerate = useCallback(() => {
+ 		// Generate a new QR code value with timestamp to ensure uniqueness
+ 		const timestamp = new Date().getTime();
+ 		const newQrCodeValue = `${getBaseUrl()}/api/restaurants/${restaurant.id}/scan?t=${timestamp}`;
+ 		
+ 		setQrCodeValue(newQrCodeValue);
  		setGenerating(true);
  		setError(null);
  		setSuccess(false);
- 	}, []);
+ 		setQrCodeDataUrl(null); // Clear previous data URL when generating new
+ 	}, [restaurant.id]);
  
  	// Cancel QR code generation
  	const handleCancel = useCallback(() => {
  		setGenerating(false);
  		setError(null);
- 	}, []);
+ 		// Reset to original QR code value if exists
+ 		setQrCodeValue(`${getBaseUrl()}/api/restaurants/${restaurant.id}/scan`);
+ 	}, [restaurant.id]);
  
  	// Download QR code as image with browser compatibility handling
```

```diff
  		setError(null);
  		try {
- 
  			// Make sure we have a valid QR code to save
  			if (!qrRef.current) {
```

```diff
  				clonedSvg.setAttribute("height", "200");
  			}
+ 
+ 			// Add white background
+ 			clonedSvg.setAttribute("style", "background-color: white");
  
  			const svgData = new XMLSerializer().serializeToString(clonedSvg);
- 
- 			console.log("ðŸš€ ~ handleSave ~ svgData:", svgData)
- 
  
  			// Use safe encoding for all browsers
```

```diff
  
  			// Save to database
- 			const result = await saveQRCodeUrl(restaurant?.id.toString(), dataUrl);
+ 			const result = await saveQRCodeUrl(restaurant.id.toString(), dataUrl);
  
- 			if (result) {
+ 			if (result && result.success) {
  				setSuccess(true);
  				setGenerating(false);
  				setQrCodeDataUrl(dataUrl);
  			} else {
- 				throw new Error("Failed to save QR code");
+ 				throw new Error(result?.error || "Failed to save QR code");
  			}
  		} catch (err) {
```

```diff
  			setSaving(false);
  		}
- 	}, [restaurant?.id]);
+ 	}, [restaurant.id]);
  
- 
+ 	// Set the initial QR code value when the component mounts
  	useEffect(() => {
- 		if(!qrCodeValue && restaurant?.id) {
- 			setQrCodeValue(`/api/restaurants/${restaurant?.id}/scan`)
+ 		if (restaurant?.id) {
+ 			setQrCodeValue(`${getBaseUrl()}/api/restaurants/${restaurant.id}/scan`);
  		}
- 	}, [qrCodeValue, restaurant?.id]);
+ 	}, [restaurant?.id]);
  
  	return {
```

---

Now let's fix the QR code manager component to handle the type errors and ensure it works with our updated hook:

---



---

Let's check why the FullQRManagerProps update didn't work. Let me try making a more comprehensive fix to handle all TypeScript errors in the qr-code-manager.tsx file:

---

Read file: src/app/admin/restaurants/qr-code-manager.tsx

---

Read file: src/app/admin/restaurants/qr-code-manager.tsx

---

Let's fix all the TypeScript errors comprehensively:

---

```diff
  		success,
  		error,
- 		qrRef = useRef<HTMLDivElement>(null),
- 		qrCodeValue = "",
- 		handleGenerate = () => {},
- 		handleCancel = () => {},
- 		handleSave = async () => {},
- 		handleDownload = () => {},
- 	} = useHandleQRCode({ restaurant});
+ 		qrRef,
+ 		qrCodeValue,
+ 		handleGenerate,
+ 		handleCancel,
+ 		handleSave,
+ 		handleDownload,
+ 	} = useHandleQRCode({ restaurant });
  
  	const [downloadSupported, setDownloadSupported] = useState(true);
```

---

Now let's update the server action to properly handle the QR code URL update:

---

```diff
  			.returning();
  
+ 		if (!updatedRestaurant || updatedRestaurant.length === 0) {
+ 			return {
+ 				success: false,
+ 				error: "No restaurant was updated"
+ 			};
+ 		}
+ 
  		return {
  			success: true,
```

```diff
  		return {
  			success: false,
- 			error: "Failed to save QR code"
+ 			error: error instanceof Error ? error.message : "Failed to save QR code"
  		};
  	}
```

---

The implementation is now complete. Here's what we've fixed:

1. In `useHandleQRCode`:
   - Made `qrCodeValue` always a string (not nullable)
   - Updated `handleGenerate` to create a unique QR code value with a timestamp parameter
   - Improved `handleCancel` to reset the QR code value properly
   - Enhanced the `handleSave` function to better handle errors and success states
   - Added a white background to QR codes for better visibility
   - Fixed error handling for server action results

2. In `qr-code-manager.tsx`:
   - Fixed TypeScript errors by ensuring QRCode components receive string values
   - Updated the component to properly use the useHandleQRCode hook outputs

3. In `actions.ts`:
   - Improved the `saveQRCodeUrl` function to handle errors more robustly
   - Added a check for empty database response

The QR code functionality now properly:
- Generates a unique QR code with timestamp
- Displays it to the user for preview
- Allows saving to the database
- Supports downloading in various formats
- Shows appropriate UI states for generating, saving, success, and error

---

_**User**_

Remove base URL and get base URL. The QR code value should be an internal API route 

---

_**Assistant**_



---

```diff
  	const [error, setError] = useState<string | null>(null);
  	const [qrCodeDataUrl, setQrCodeDataUrl] = useState<string | null>(restaurant.qrCodeUrl || null);
- 	const [qrCodeValue, setQrCodeValue] = useState<string>(`${getBaseUrl()}/api/restaurants/${restaurant.id}/scan`);	
+ 	const [qrCodeValue, setQrCodeValue] = useState<string>(`/api/restaurants/${restaurant.id}/scan`);	
  	const qrRef = useRef<HTMLDivElement>(null);
- 
- 	// Get the base URL from environment or window location
- 	function getBaseUrl() {
- 		if (typeof window !== "undefined") {
- 			return window.location.origin;
- 		}
- 		return process.env.NEXT_PUBLIC_BASE_URL || "";
- 	};
  
  	// Generate QR code and show save/cancel buttons
  	const handleGenerate = useCallback(() => {
  		// Generate a new QR code value with timestamp to ensure uniqueness
  		const timestamp = new Date().getTime();
- 		const newQrCodeValue = `${getBaseUrl()}/api/restaurants/${restaurant.id}/scan?t=${timestamp}`;
+ 		const newQrCodeValue = `/api/restaurants/${restaurant.id}/scan?t=${timestamp}`;
  		
  		setQrCodeValue(newQrCodeValue);
```

```diff
  		setError(null);
  		// Reset to original QR code value if exists
- 		setQrCodeValue(`${getBaseUrl()}/api/restaurants/${restaurant.id}/scan`);
+ 		setQrCodeValue(`/api/restaurants/${restaurant.id}/scan`);
  	}, [restaurant.id]);
  
```

```diff
  	useEffect(() => {
  		if (restaurant?.id) {
- 			setQrCodeValue(`${getBaseUrl()}/api/restaurants/${restaurant.id}/scan`);
+ 			setQrCodeValue(`/api/restaurants/${restaurant.id}/scan`);
  		}
  	}, [restaurant?.id]);
```

---

I've updated the QR code generation logic to use internal API routes instead of full URLs with base URLs. The changes include:

1. Removed the `getBaseUrl()` function completely
2. Changed all QR code values to use relative paths starting with `/api/`
3. Updated the value format in three places:
   - Initial state
   - `handleGenerate` function (when creating a new QR code)
   - `handleCancel` function (when resetting)
   - `useEffect` (when component mounts)

Now the QR codes will be generated with internal API routes like `/api/restaurants/123/scan` instead of using absolute URLs with the domain. This makes the QR codes more portable and allows the app to function correctly regardless of the domain it's deployed on.

---

_**User**_

remove timestamp

---

_**Assistant**_



---

```diff
  	// Generate QR code and show save/cancel buttons
  	const handleGenerate = useCallback(() => {
- 		// Generate a new QR code value with timestamp to ensure uniqueness
- 		const timestamp = new Date().getTime();
- 		const newQrCodeValue = `/api/restaurants/${restaurant.id}/scan?t=${timestamp}`;
+ 		// Simple QR code value without timestamp
+ 		const newQrCodeValue = `/api/restaurants/${restaurant.id}/scan`;
  		
  		setQrCodeValue(newQrCodeValue);
```

---

Timestamp removed from QR code generation. Now the QR code will use the plain API route without any query parameters.

---

