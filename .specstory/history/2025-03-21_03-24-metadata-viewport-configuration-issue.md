<!-- Generated by SpecStory -->

# Metadata Viewport Configuration Issue (2025-03-20 22:24:15)

_**User**_

âš  Unsupported metadata viewport is configured in metadata export in /. Please move it to viewport export instead.

---

_**Assistant**_

```diff
- 
+ export const metadata = {
+   title: "My App",
+   description: "My App Description",
+   // Removed viewport config from here
+ };
+ 
+ export const viewport = {
+   width: "device-width",
+   initialScale: 1,
+   maximumScale: 1
+ }; 
```

---

Here's the precise code change to remove viewport config from the metadata export and move it to a separate viewport export:

```typescript:app/layout.tsx
export const metadata = {
  title: "My App",
  description: "My App Description",
  // Removed viewport config from here
};

export const viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
};
```

This removes the unsupported viewport configuration from metadata and exports it separately to comply with Next.js requirements.

---

_**User**_

Make the QR code download as a PNG file

---

_**Assistant**_

```diff
  }
  
- // Add this new helper function before the QRCodeManager component
+ // Updated download function to convert SVG to PNG
  const downloadQRCodeFromElement = (
  	element: HTMLDivElement | null,
- 	restaurantName: string,
+ 	restaurantName: string
  ) => {
  	if (!element) return;
- 
  	try {
- 		// Get the SVG element directly from the container
  		const svgElement = element.querySelector("svg");
  		if (!svgElement) {
  			console.error("SVG element not found");
  			return;
  		}
- 
- 		// Add white background to ensure visibility
+ 		// Ensure white background
  		svgElement.setAttribute("style", "background-color: white");
- 
- 		// Serialize the SVG to a string
+ 		// Serialize SVG
  		const svgData = new XMLSerializer().serializeToString(svgElement);
- 
- 		// Create a data URL
- 		const dataUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgData)}`;
- 
- 		// Create a sanitized filename
- 		const filename = `${restaurantName.replace(/\s+/g, "-").toLowerCase()}-qrcode.svg`;
- 
- 		// Create and trigger download
- 		const link = document.createElement("a");
- 		link.href = dataUrl;
- 		link.download = filename;
- 		document.body.appendChild(link);
- 		link.click();
- 		document.body.removeChild(link);
+ 		// Create a blob from SVG data
+ 		const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
+ 		const url = URL.createObjectURL(svgBlob);
+ 
+ 		const image = new Image();
+ 		image.crossOrigin = "anonymous";
+ 		image.onload = () => {
+ 			const canvas = document.createElement("canvas");
+ 			// Attempt to get width/height from SVG attributes, fallback to image dimensions
+ 			const widthAttr = svgElement.getAttribute("width");
+ 			const heightAttr = svgElement.getAttribute("height");
+ 			const width = widthAttr ? parseInt(widthAttr) : image.width;
+ 			const height = heightAttr ? parseInt(heightAttr) : image.height;
+ 			canvas.width = width;
+ 			canvas.height = height;
+ 			const context = canvas.getContext("2d");
+ 			if (!context) {
+ 				console.error("Unable to get canvas context");
+ 				return;
+ 			}
+ 			// Fill canvas with white background
+ 			context.fillStyle = "#ffffff";
+ 			context.fillRect(0, 0, width, height);
+ 			context.drawImage(image, 0, 0, width, height);
+ 			URL.revokeObjectURL(url);
+ 			const pngDataUrl = canvas.toDataURL("image/png");
+ 			const filename = `${restaurantName.replace(/\s+/g, "-").toLowerCase()}-qrcode.png`;
+ 			const link = document.createElement("a");
+ 			link.href = pngDataUrl;
+ 			link.download = filename;
+ 			document.body.appendChild(link);
+ 			link.click();
+ 			document.body.removeChild(link);
+ 		};
+ 		image.onerror = (err) => {
+ 			console.error("Error loading SVG as image", err);
+ 		};
+ 		image.src = url;
  	} catch (err) {
- 		console.error("Direct download failed:", err);
+ 		console.error("Direct PNG download failed:", err);
  	}
  };
```

---

```diff
  }
  
- // Updated download function to convert SVG to PNG
+ // Updated download function to convert SVG to PNG with linter fixes
  const downloadQRCodeFromElement = (
  	element: HTMLDivElement | null,
```

```diff
  		const url = URL.createObjectURL(svgBlob);
  
- 		const image = new Image();
+ 		const image = document.createElement("img");
  		image.crossOrigin = "anonymous";
  		image.onload = () => {
```

```diff
  			document.body.removeChild(link);
  		};
- 		image.onerror = (err) => {
+ 		image.onerror = (err: Event) => {
  			console.error("Error loading SVG as image", err);
  		};
```

---

```diff
  }
  
- // Updated download function to convert SVG to PNG with linter fixes
+ // Updated download function to convert SVG to PNG with linter fixes and event listener for error
  const downloadQRCodeFromElement = (
  	element: HTMLDivElement | null,
```

```diff
  			document.body.removeChild(link);
  		};
- 		image.onerror = (err: Event) => {
- 			console.error("Error loading SVG as image", err);
- 		};
+ 		image.addEventListener("error", (event: Event) => {
+ 			console.error("Error loading SVG as image", event);
+ 		});
  		image.src = url;
  	} catch (err) {
```

---

Here's the updated helper function that converts the QR code from SVG to PNG and downloads it:

```typescript:src/app/admin/restaurants/qr-code-manager.tsx
// Updated download function to convert SVG to PNG with linter fixes and event listener for error
const downloadQRCodeFromElement = (
	element: HTMLDivElement | null,
	restaurantName: string
) => {
	if (!element) return;
	try {
		const svgElement = element.querySelector("svg");
		if (!svgElement) {
			console.error("SVG element not found");
			return;
		}
		// Ensure white background
		svgElement.setAttribute("style", "background-color: white");
		// Serialize SVG
		const svgData = new XMLSerializer().serializeToString(svgElement);
		// Create a blob from SVG data
		const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
		const url = URL.createObjectURL(svgBlob);

		const image = document.createElement("img");
		image.crossOrigin = "anonymous";
		image.onload = () => {
			const canvas = document.createElement("canvas");
			// Attempt to get width/height from SVG attributes, fallback to image dimensions
			const widthAttr = svgElement.getAttribute("width");
			const heightAttr = svgElement.getAttribute("height");
			const width = widthAttr ? parseInt(widthAttr) : image.width;
			const height = heightAttr ? parseInt(heightAttr) : image.height;
			canvas.width = width;
			canvas.height = height;
			const context = canvas.getContext("2d");
			if (!context) {
				console.error("Unable to get canvas context");
				return;
			}
			// Fill canvas with white background
			context.fillStyle = "#ffffff";
			context.fillRect(0, 0, width, height);
			context.drawImage(image, 0, 0, width, height);
			URL.revokeObjectURL(url);
			const pngDataUrl = canvas.toDataURL("image/png");
			const filename = `${restaurantName.replace(/\s+/g, "-").toLowerCase()}-qrcode.png`;
			const link = document.createElement("a");
			link.href = pngDataUrl;
			link.download = filename;
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		};
		image.addEventListener("error", (event: Event) => {
			console.error("Error loading SVG as image", event);
		});
		image.src = url;
	} catch (err) {
		console.error("Direct PNG download failed:", err);
	}
};
```

This function now creates a Blob from the SVG data, loads it into an image, draws the image onto a canvas with a white background (to ensure clarity), converts the canvas to a PNG data URL, and finally triggers a download of the PNG file.

---

